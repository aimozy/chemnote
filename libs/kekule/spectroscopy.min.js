!function(){"use strict";var e=Class.PropertyScope,t=Kekule.ArrayUtils,a=Kekule.Unit;Kekule.Spectroscopy={},Kekule.Spectroscopy.DataMode={CONTINUOUS:1,PEAK:2},Kekule.Spectroscopy.Utils={mergeDataRange:function(e,a){var r={},n=t.clone(Kekule.ObjUtils.getOwnedFieldNames(e));t.pushUnique(n,Kekule.ObjUtils.getOwnedFieldNames(a));for(var i=0,l=n.length;i<l;++i){var s=n[i];e[s]?a[s]?r[s]={min:e[s].min<a[s].min?e[s].min:a[s].min,max:e[s].max>a[s].max?e[s].max:a[s].max}:r[s]=Object.extend(e[s]):r[s]=Object.extend(a[s])}return r},calcScalePointInfo:function(e,t,a){a<=0&&(a=10);var r,n=[Math.log10(Math.abs(e)),Math.log10(Math.abs(t))],i=Math.floor(Math.max(n[0],n[1])),l=Math.sign(e)===Math.sign(t)?Math.floor(Math.min(n[0],n[1],0)):-1/0,s=i>6,o=t-e,u=o/a,c=Math.max(Math.floor(Math.log10(Math.abs(u))),l),d=Math.pow(10,c);r=r<10&&o>.5?2*Math.ceil(r/d/2)*d:Math.ceil(u/d)*d;for(var p=Math.ceil(e/r)*r,f=Math.floor(t/r)*r,h={useSciForm:s,scaleFrom:p,scaleTo:f,scaleSectionCount:Math.round((f-p)/r),scaleValues:[],scaleBase:d,scaleFromOnBase:p/d,scaleToOnBase:f/d,fixDigitsCountAfterPoint:Math.max(-c,0)},g=0,S=h.scaleSectionCount+1;g<S;++g)h.scaleValues.push(Math.round(g*r/d)*d+p);return h}},Kekule.Spectroscopy.DataValueConverterManager={_converters:[],register:function(e){n._converters.push(e)},unregister:function(e){var t=DMC._converters.indexOf(e);t>=0&&DMC._converters.splice(t,1)},doConvert:function(e,t,a,r,i,l){if(a===r)return e;if(!Kekule.NumUtils.isNormalNumber(e))return e;var s=n._converters;if(s.length){var o=Kekule.Unit.getUnit(a),u=Kekule.Unit.getUnit(r);if(o&&u)for(var c=s.length-1;c>=0;--c){var d=s[c];if(d.canConvert(e,t,o,u,i,l))return d.convert(e,t,o,u,i,l)}}return Kekule.error(Kekule.$L("ErrorMsg.UNABLE_TO_CONVERT_BETWEEN_UNITS").format(o.getKey(),u.getKey())),null},getAltUnits:function(e,a,r,i){var l=[],s=n._converters;if(s.length){var o=Kekule.Unit.getUnit(a);if(o)for(var u=s.length-1;u>=0;--u){var c=s[u].getAltUnits(e,o,r,i)||[];t.pushUnique(l,c)}}return l}};var r,n=Kekule.Spectroscopy.DataValueConverterManager;n.register({convert:function(e,t,a,r,n,i){return a.convertValueTo(e,r)},canConvert:function(e,t,a,r,n,i){return a.canConvertValueTo(r)},getAltUnits:function(e,t,a,r){return t.category.getConvertableUnits()}}),n.register({convert:function(e,t,r,n,i,l){var s=l.getParameter("observeFrequency");if(r.category===a.Frequency){var o=(u=r.convertValueTo(e,s.getUnit()))/s.getValue();return a.Dimensionless.ONE.convertValueTo(o,n)}if(r.category===Kekule.Unit.Dimensionless){var u=r.convertValueToStandard(e)*s.getValue();return a.getUnit(s.getUnit()).convertValueTo(u,n)}},canConvert:function(e,t,a,r,n,i){if(i.getSpectrumType()===Kekule.Spectroscopy.SpectrumType.NMR){var l=i.getParameter("observeFrequency");if(l&&Kekule.Unit.getUnit(l.getUnit()).category===Kekule.Unit.Frequency)return a.category===Kekule.Unit.Frequency&&r.category===Kekule.Unit.Dimensionless||a.category===Kekule.Unit.Dimensionless&&r.category===Kekule.Unit.Frequency}return!1},getAltUnits:function(e,t,a,r){var n=[];if(r.getSpectrumType()===Kekule.Spectroscopy.SpectrumType.NMR){var i=r.getParameter("observeFrequency");i&&Kekule.Unit.getUnit(i.getUnit()).category===Kekule.Unit.Frequency&&(t.category===Kekule.Unit.Frequency?n.push(Kekule.Unit.Dimensionless.PARTS_PER_MILLION):t.category===Kekule.Unit.Dimensionless&&(n=n.concat(Kekule.Unit.Frequency.getConvertableUnits())))}return n}}),n.register({convert:function(e,t,r,n,i,l){if(r.category===a.Length){var s=1/r.convertValueToStandardEx(e).value;return n.convertValueFromStandard(s)}if(r.category===a.WaveNumber){var o=1/r.convertValueToStandardEx(e).value;return n.convertValueFromStandard(o)}},canConvert:function(e,t,a,r,n,i){return i.getSpectrumType()===Kekule.Spectroscopy.SpectrumType.IR&&(a.category===Kekule.Unit.Length&&r.category===Kekule.Unit.WaveNumber||a.category===Kekule.Unit.WaveNumber&&r.category===Kekule.Unit.Length)},getAltUnits:function(e,t,a,r){var n;return r.getSpectrumType()===Kekule.Spectroscopy.SpectrumType.IR&&(t.category===Kekule.Unit.Length?n=[Kekule.Unit.WaveNumber.RECIPROCAL_CENTIMETER]:t.category===Kekule.Unit.WaveNumber&&(n=[Kekule.Unit.Length.getConvertableUnits()])),n}}),Kekule.Spectroscopy.SpectrumVarDefinition=Class.create(Kekule.VarDefinition,{CLASS_NAME:"Kekule.Spectroscopy.SpectrumVarDefinition",initProperties:function(){this.defineProp("internalUnit",{dataType:DataType.STRING,serializable:!1,getter:function(){return this.getUnit()},setter:function(e){this.setUnit(e)}}),this.defineProp("externalUnit",{dataType:DataType.STRING})},getActualExternalUnit:function(){return this.getExternalUnit()||this.getInternalUnit()},hasDifferentExternalUnit:function(){var e=this.getExternalUnit();return!(!e||e===this.getInternalUnit())}}),Kekule.Spectroscopy.SpectrumDataSection=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Spectroscopy.SpectrumDataSection",initialize:function(e,t,a){this.setPropStoreFieldValue("name",e),this.setPropStoreFieldValue("localVarInfos",[]),this.setPropStoreFieldValue("dataItems",[]),this.setPropStoreFieldValue("parent",t),this.tryApplySuper("initialize",[]),a&&this.setLocalVariables(a),this.setDataSorted(!0),this._cache={}},doFinalize:function(){this.getParent()&&this.getParent().removeChild&&this.getParent().removeChild(this),this.clear();for(var e=this.getVariables(),t=0,a=e.length;t<a;++t)e[t].finalize();this.setPropStoreFieldValue("localVarInfos",null),this.tryApplySuper("doFinalize")},initProperties:function(){this.defineProp("parent",{dataType:"Kekule.MapEx",setter:null,serializable:!1}),this.defineProp("name",{dataType:DataType.STRING}),this.defineProp("title",{dataType:DataType.STRING}),this.defineProp("localVarInfos",{dataType:DataType.ARRAY,setter:null}),this.defineProp("localVarSymbols",{dataType:DataType.ARRAY,scope:e.PRIVATE,serializable:!1,getter:function(){var e=[],t=this.getActualLocalVarInfos();if(t&&t.length)for(var a=0,r=t.length;a<r;++a){var n=t[a];e.push(n.symbol)}return e},setter:function(e){var t=e||[];this._updateLocalVarInfosFromSymbols(t)}}),this.defineProp("mode",{dataType:DataType.INT,enumSource:Kekule.Spectroscopy.DataMode,setter:function(e){this.getMode()!==e&&(this.setPropStoreFieldValue("mode",e),this.notifyDataChange())}}),this.defineProp("defPeakRoot",{dataType:DataType.Hash}),this.defineProp("dataItems",{dataType:DataType.ARRAY,setter:null,scope:e.PRIVATE})},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setMode(Kekule.Spectroscopy.DataMode.CONTINUOUS)},getAutoIdPrefix:function(){return"sec"},ownerChanged:function(e,t){for(var a=0,r=this.getDataCount();a<r;++a){var n=this.getExtraInfoAt(a);n&&n.setOwner&&n.setOwner(e)}this.tryApplySuper("ownerChanged",[e,t])},doSaveProp:function(e,t,a,r){if(t.serializable){if("dataItems"===t.name){var n=r.createChildStorageNode(a,r.propNameToStorageName("dataItems"),!1),i=r.createChildStorageNode(n,r.propNameToStorageName("values"),!0);r.save(e.getDataItems(),i);var l=e._extractAllExtraInfoOfDataItems();if(l.length){i=r.createChildStorageNode(n,r.propNameToStorageName("extras"),!0);r.save(l,i)}return!0}return!1}},doLoadProp:function(e,t,a,r){if(t.serializable){if("dataItems"===t.name){var n=[],i=r.getChildStorageNode(a,r.propNameToStorageName("dataItems")),l=r.getChildStorageNode(i,r.propNameToStorageName("values"));if(r.load(n,l),e.setPropStoreFieldValue("dataItems",n),l=r.getChildStorageNode(i,r.propNameToStorageName("extras"))){var s=[];r.load(s,l),e._writeExtraInfoOfDataItems(s)}return!0}return!1}},_extractAllExtraInfoOfDataItems:function(){for(var e=[],t=0,a=this.getDataCount();t<a;++t){var r=this.getExtraInfoAt(t);r&&e.push({index:t,info:r})}return e},_writeExtraInfoOfDataItems:function(e){for(var t=0,a=e.length;t<a;++t){var r=e[t];this.setExtraInfoAt(r.index,r.info)}},isPeakSection:function(){return this.getMode()===Kekule.Spectroscopy.DataMode.PEAK},getParentSpectrum:function(){for(var e=this.getParent();e&&!(e instanceof Kekule.Spectroscopy.Spectrum)&&e.getParent;)e=e.getParent();return e},getParentVariables:function(){var e=this.getParentSpectrum();return e&&e.getVariables()||[]},getActualLocalVarInfos:function(){var e=t.clone(this.getLocalVarInfos());if(!e||!e.length)for(var a=this.getParentVariables(),r=0,n=a.length;r<n;++r)e.push({symbol:a[r].symbol});return e},_updateLocalVarInfosFromSymbols:function(e,t){for(var a=e||[],r=[],n=this.getParentSpectrum(),i=0,l=a.length;i<l;++i){var s=a[i];this._pushLocalVariable(n,s,r)}this.setPropStoreFieldValue("localVarInfos",r),this.notifyPropSet("localVarInfos",r,t)},_pushLocalVariable:function(e,t,a){(a||(a=this.getLocalVarInfos()),e&&e.getVariable)&&(e.getVariable(t)&&a.push({symbol:t}))},setLocalVariables:function(e){for(var t,a=[],r=[],n=0,i=e.length;n<i;++n)"string"==typeof(t=e[n])?r.push(t):a.push(t);a.length?(this.setPropStoreFieldValue("localVarInfos",a),this.notifyPropSet("localVarInfos",a)):r.length&&this._updateLocalVarInfosFromSymbols(r)},getLocalVarInfoIndex:function(e){var t=-1,a=this.getActualLocalVarInfos();if("number"==typeof e)t=e;else for(var r=e.getSymbol?e.getSymbol():e,n=0,i=a.length;n<i;++n)if(r===a[n].symbol){t=n;break}return t},getLocalVarInfo:function(e){var t=this.getLocalVarInfoIndex(e);return t>=0?this.getActualLocalVarInfos()[t]:null},getLocalVarInfoValue:function(e,t){var a=this.getLocalVarInfo(e);return a&&a[t]},setLocalVarInfoValue:function(e,t,a){this.getLocalVarInfo(e)[t]=a},getLocalVarDef:function(e){var t=this.getLocalVarInfoValue(e,"symbol"),a=this.getParentSpectrum();return a&&a.getVariable(t)},getLocalVarInfoOfDependency:function(e){for(var t=[],a=this.getActualLocalVarInfos(),r=0,n=a.length;r<n;++r){var i=this.getLocalVarDef(r);if(i.getDependency()===e){var l=Object.extend({},a[r]);l.varDef=i,t.push(l)}}return t},getContinuousVarRange:function(e){var t=this.getParent(),a=this.getLocalVarInfo(e);return a.continuousRange||t&&t.getContinuousVarRange&&t.getContinuousVarRange(a.symbol)},setContinuousVarRange:function(e,t,a){return this.setLocalVarInfoValue(e,"continuousRange",{fromValue:t,toValue:a}),this},clearContinuousVarRange:function(e){return this.setLocalVarInfoValue(e,"continuousRange",null),this},setDefaultVarValue:function(e,t){return this.setLocalVarInfoValue(e,"defaultValue",t),this},clearDefaultVarValue:function(e){return this.setDefaultVarValue(e,null)},getDefaultVarValue:function(e){var t=this.getLocalVarInfoValue(e,"defaultValue");if(Kekule.ObjUtils.isUnset(t)){var a=this.getLocalVarInfo(e),r=this.getParent();t=r&&r.getDefaultVarValue(a.symbol)}return t},getVarDisplayRange:function(e,t){var a=t||{},r=this.getLocalVarInfoIndex(e),n=this.getLocalVarInfo(r),i=n.displayRange?Object.extend({},n.displayRange):null;if(!i){var l=this.getLocalVarDef(r).getInfoValue("displayRange");l&&(i=Object.extend({},l))}return!i&&a.autoCalc&&(i=this.calcDataRange(r,{basedOnInternalUnit:!0})[n.symbol]),a.basedOnInternalUnit||(i=this._convertDataRangeToExternalUnit(i,r)),i},setVarDisplayRange:function(e,t,a,r){var n={min:t,max:a};if((r||{}).basedOnExternalUnit){var i=this.getLocalVarInfoIndex(e);n=this._convertDataRangeToInternalUnit(n,i)}return this.setLocalVarInfoValue(e,"displayRange",n),this},clearVarDisplayRange:function(e){return this.setLocalVarInfoValue(e,"displayRange",null),this},getDisplayRangeOfVars:function(e,t){var a={};e||(e=this.getLocalVarSymbols());for(var r=0,n=e.length;r<n;++r){a[this._varToVarSymbol(e[r])]=this.getVarDisplayRange(e[r],t)}return a},_varToVarSymbol:function(e){var t=this.getLocalVarDef(e);return t?t.getSymbol():null},_varToVarSymbols:function(e){var a=[],r=e?t.toArray(e):null;if(r)for(var n=0,i=r.length;n<i;++n)a.push(this._varToVarSymbol(r[n]));else a=this.getLocalVarSymbols();return a},_getDefaultPeakRoot:function(){for(var e={},t=0,a=this.getActualLocalVarInfos().length;t<a;++t){var r=this.getLocalVarDef(t);r.getDependency()!==Kekule.VarDependency.INDEPENDENT&&(e[r.getSymbol()]=0)}return e},calcDataRange:function(e,t){var a=t||{},r=this._varToVarSymbols(e),n=function(e){return!Kekule.NumUtils.isNormalNumber(e)},i={},l=this._cache.ranges;l||(l={},this._cache.ranges=l);for(var s=[],o=0,u=r.length;o<u;++o){l[p=r[o]]?i[p]=Object.extend({},l[p]):s.push(p)}if(s.length){var c=this,d=this.isPeakSection();this.forEach(function(e,t){for(var r=0,l=s.length;r<l;++r){var o=s[r];if(!n(e[o])&&(i[o]||(i[o]={}),i[o].min=n(i[o].min)?e[o]:Math.min(i[o].min,e[o]),i[o].max=n(i[o].max)?e[o]:Math.max(i[o].max,e[o]),d&&!a.ignorePeakRoot)){var u=c.getPeakRootValueOf(e);u&&!n(u[o])&&(i[o].min=n(i[o].min)?u[o]:Math.min(i[o].min,u[o]),i[o].max=n(i[o].max)?u[o]:Math.max(i[o].max,u[o]))}}},null,{basedOnInternalUnit:!0});for(o=0,u=s.length;o<u;++o){l[p=s[o]]=Object.extend({},i[p])}}if(!a.basedOnInternalUnit)for(o=0,u=r.length;o<u;++o){var p=r[o];i[p]=this._convertDataRangeToExternalUnit(i[p],o)}return i},_convertDataRangeToExternalUnit:function(e,t){if(!e)return e;for(var a=["min","max"],r=0,n=a.length;r<n;++r){var i=a[r];e[i]=this._convertVarValueToExternal(e[i],t)}if(e.min>e.max){var l=e.min;e.min=e.max,e.max=l}return e},_convertDataRangeToInternalUnit:function(e,t){if(!e)return e;for(var a=["min","max"],r=0,n=a.length;r<n;++r){var i=a[r];e[i]=this._convertVarValueToInternal(e[i],t)}if(e.min>e.max){var l=e.min;e.min=e.max,e.max=l}return e},calcDataAverage:function(e,t){var a=t||{},r=this._varToVarSymbols(e),n={},i=this._cache.averages,l=function(e){return!Kekule.NumUtils.isNormalNumber(e)};i||(i={},this._cache.averages=i);for(var s=[],o=0,u=r.length;o<u;++o){var c=r[o];l(i[c])?s.push(c):n[c]=i[c]}if(s.length){var d={},p={};for(o=0,u=s.length;o<u;++o)d[s[o]]=0,p[s[o]]=0;this.forEach(function(e,t){for(var a=0,r=s.length;a<r;++a){var n=s[a],i=e[n];l(i)||(d[n]+=i,++p[n])}},null,{basedOnInternalUnit:!0});for(o=0,u=s.length;o<u;++o){n[c=s[o]]=d[c]/p[c],i[c]=n[c]}}if(!a.basedOnInternalUnit)for(o=0,u=r.length;o<u;++o){n[c=r[o]]=this._convertVarValueToExternal(n[o])}return n},getContinuousVarSymbols:function(){for(var e=[],t=this.getActualLocalVarInfos(),a=0,r=t.length;a<r;++a)this.getContinuousVarRange(a)&&e.push(t[a].symbol);return e},_itemHashToArray:function(e){if(!e)return null;for(var a=[],r=this.getLocalVarSymbols(),n=0,i=r.length;n<i;++n)a.push(e[r[n]]);if(e._extra)a._extra=e._extra;else{var l=t.exclude(Kekule.ObjUtils.getOwnedFieldNames(e,!1),r);l.length&&(a._extra={});for(n=0,i=l.length;n<i;++n)a._extra[l[n]]=e[l[n]]}return a},_itemArrayToHash:function(e,t){if(!e)return null;for(var a={},r=this.getLocalVarSymbols(),n=0,i=Math.min(r.length,e.length);n<i;++n){var l;l=t.basedOnInternalUnit?e[n]:this._convertVarValueToExternal(e[n],n),a[r[n]]=l}return e._extra&&(a._extra=e._extra),a},_convertVarValueToNewUnit:function(e,t,a,r){return Kekule.NumUtils.isNormalNumber(e)?Kekule.Spectroscopy.DataValueConverterManager.doConvert(e,t,a,r,this,this.getParent()):e},_convertVarValueToExternal:function(e,t){var a=e,r=this.getLocalVarDef(t);return r&&r.hasDifferentExternalUnit&&r.hasDifferentExternalUnit()&&(a=this._convertVarValueToNewUnit(e,r,r.getInternalUnit(),r.getActualExternalUnit())),a},_convertVarValueToInternal:function(e,t){var a=e,r=this.getLocalVarDef(t);return r&&r.hasDifferentExternalUnit&&r.hasDifferentExternalUnit()&&(a=this._convertVarValueToNewUnit(e,r,r.getActualExternalUnit(),r.getInternalUnit())),a},isDataSorted:function(){return this._sorted||this.getDataCount()<=1},setDataSorted:function(e){return this._sorted=!!e,this},sort:function(e){if(!this.isDataSorted()){var a=this,r=e?function(t,r){return e(a._itemArrayToHash(t),a._itemArrayToHash(r))}:function(e,a){return t.compare(e,a)};return this.getDataItems().sort(r),this.setDataSorted(!0),this}},getDataCount:function(){return this.getDataItems().length},clearCache:function(){this._cache={}},notifyDataChange:function(){var e=this.getDataItems();this.setDataSorted(!1),this.clearCache(),this.notifyPropSet("dataItems",e),this.invokeEvent("dataChange",{data:e})},clear:function(){this.setDataItems([]),this.notifyDataChange(),this.setDataSorted(!0)},appendData:function(e){var t;if(t=DataType.isArrayValue(e)?e:this._itemHashToArray(e))return this.getDataItems().push(t),this.notifyDataChange(),t},removeData:function(e){var t=this.getDataItems().indexOf(e);return this.removeDataItemAt(t)},removeDataAt:function(e){var t=this.getDataItems().splice(e,1);return this.notifyDataChange(),t},getRawValueAt:function(e){var a=this.getDataItems()[e];if(a){for(var r=t.clone(a),n=this.getMode()===Kekule.Spectroscopy.DataMode.CONTINUOUS,i=this.getDataCount()-1,l=0,s=r.length;l<s;++l){var o=r[l];if(DataType.isUndefinedValue(o)||DataType.isNullValue(o)){var u=this.getDefaultVarValue(l);if(Kekule.ObjUtils.notUnset(u))o=u;else if(n){var c=this.getContinuousVarRange(l);c&&(o=i>1?e/i*(c.toValue-c.fromValue)+c.fromValue:c.fromValue)}}r[l]=o}return a._extra&&(r._extra=a._extra),r}return null},getHashValueAt:function(e,t){return this._itemArrayToHash(this.getRawValueAt(e),t||{})},getValueAt:function(e,t){return this.getHashValueAt(e,t)},setRawValueAt:function(e,t){var a=this.getDataItems()[e];return a&&a._extra&&this._extraInfoRemoved(a._extra),this.getDataItems()[e]=t,t._extra&&this._extraInfoAdded(t._extra),this},setHashValueAt:function(e,t,a){var r=this._itemHashToArray(t);return this.setRawValueAt(e,r),this},setValueAt:function(e,t,a){var r;return r=DataType.isArrayValue(t)?t:this._itemHashToArray(t),this.setRawValueAt(e,r),this},getExtraInfoOf:function(e){return e._extra},setExtraInfoOf:function(e,t){return e._extra&&this._extraInfoRemoved(e._extra),e._extra=t,this._extraInfoAdded(t),this},getExtraInfoAt:function(e){var t=this.getDataItems()[e];return t&&t._extra},setExtraInfoAt:function(e,t){var a=this.getDataItems()[e];return a._extra&&this._extraInfoRemoved(a._extra),a._extra=t,this._extraInfoAdded(t),this},_extraInfoAdded:function(e){e&&e instanceof Kekule.ChemObject&&(e.setParent(this),e.setOwner(this.getOwner()))},_extraInfoRemoved:function(e){e&&e instanceof Kekule.ChemObject&&e.getParent()===this&&(e.setParent(null),e.setOwner(null))},getPeakRootValueOf:function(e){if(this.getMode()!==Kekule.Spectroscopy.DataMode.PEAK)return null;var t=this.getDefPeakRoot()||this._getDefaultPeakRoot();return Object.extend(Object.extend({},e),t)},getPeakRootValueAt:function(e){return this.getPeakRootValueOf(this.getValueAt(e))},getDependentValues:function(e,t){return this.doGetDependentValues(independantValues,t)},doGetDependentValues:function(e,t){return{}},getIterator:function(){return this.doGetIterator()},doGetIterator:function(){var e=this.getDataItems(),t=this;return{index:0,next:function(a){if(this.index>=e.length)return{done:!0};var r={done:!1,value:t.getHashValueAt(this.index,a)};return++this.index,r}}},forEach:function(e,t,a){var r=this.getIterator();if(r)for(var n=0,i=r.next(a);!i.done;)e.apply(t,[i.value,n]),++n,i=r.next();return this}}),Kekule.Spectroscopy.SpectrumData=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Spectroscopy.SpectrumData",initialize:function(e,a,r){this.tryApplySuper("initialize",[e]),this.setPropStoreFieldValue("variables",a?t.clone(a):[]);var n=new Kekule.ChemObjList(null,Kekule.Spectroscopy.SpectrumDataSection,!0);this.setPropStoreFieldValue("sections",n),this.setParent(r),n.setOwner(this.getOwner())},doFinalize:function(){this.getSections().finalize();for(var e=this.getVariables()||[],t=0,a=e.length;t<a;++t)e[t].finalize();this.setPropStoreFieldValue("variables",null),this.tryApplySuper("doFinalize")},initProperties:function(){this.defineProp("owner",{dataType:"Kekule.ChemSpace",serializable:!1,scope:Class.PropertyScope.PUBLIC,getter:function(){return this.getPropStoreFieldValue("owner")||this._getDefaultOwner()},setter:function(e){if(e!==this.getPropStoreFieldValue("owner")){this.setPropStoreFieldValue("owner",e);var t=this.getOwner(),a=this.getSections();a&&a.setOwner(t)}}}),this.defineProp("parent",{dataType:"Kekule.Spectroscopy.Spectrum",serializable:!1,setter:function(e){this.setPropStoreFieldValue("parent",e);var t=this.getSections();t&&t.setParent(this.getParent()||this)}}),this.defineProp("sections",{dataType:"Kekule.ChemObjList",setter:function(e){var t=this.getSections();t!==e&&(t&&t.finalize(),e&&(e._transparent=!0,e.setParent(this.getParent()||this),e.setOwner(this.getOwner())),this.setPropStoreFieldValue("sections",e))}}),this.defineProp("autoCreateSection",{dataType:DataType.BOOL}),this.defineProp("activeSectionIndex",{dataType:DataType.INT,getter:function(){return this.getSectionCount()<=0?-1:1===this.getSectionCount()?0:this.getPropStoreFieldValue("activeSectionIndex")},setter:function(e){e>=0&&e<=this.getSectionCount()&&this.setPropStoreFieldValue("activeSectionIndex",e)}}),this.defineProp("activeSection",{dataType:"Kekule.Spectroscopy.SpectrumDataSection",serializable:!1,getter:function(){var e=this.getSectionAt(this.getActiveSectionIndex()||0);return!e&&this.getSectionCount()<=0&&this.getAutoCreateSection()&&(e=this.createSection(this.getVariables())),e},setter:function(e){this.setActiveSectionIndex(this.indexOfSection(e))}}),this.defineProp("variables",{dataType:DataType.ARRAY}),this.defineProp("varSymbols",{dataType:DataType.ARRAY,setter:null,scope:e.PRIVATE,getter:function(){for(var e=[],t=this.getVariables()||[],a=0,r=t.length;a<r;++a){var n=t[a];e.push(n.getSymbol())}return e}}),this.defineProp("mode",{dataType:DataType.INT,enumSource:Kekule.Spectroscopy.DataMode})},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setAutoCreateSection(!0),this.setMode(Kekule.Spectroscopy.DataMode.CONTINUOUS)},_getDefaultOwner:function(){var e=this.getParent();return e&&e.getOwner&&e.getOwner()},getHigherLevelObj:function(){return this.getParent()},getChildHolder:function(){return this.getSections()},loaded:function(){var e=this.getSections();e&&(e.parentChanged(this),e.ownerChanged(this.getOwner())),this.tryApplySuper("loaded")},createSection:function(e,t){var a=new Kekule.Spectroscopy.SpectrumDataSection(null,this,e);return a.setMode(t||this.getMode()),this.getSections().appendChild(a),a},clearSection:function(){for(var e=this.getChildren(),t=0,a=e.length;t<a;++t)e[t].clear(),e[t].setParent(null),e[t].finalize();this.getSections().clear()},getSectionCount:function(){return this.getSections().getChildCount()},getSectionAt:function(e){return this.getSections().getItemAt(e)},indexOfSection:function(e){return this.getSections().indexOfItem(e)},hasSection:function(e){return this.indexOfSection(e)>=0},removeSectionAt:function(e){return this.getSections().removeItemAt(e)},removeSection:function(e){return this.getSections().removeItem(e)},insertSectionAt:function(e,t){return this.getSections().insertItemAt(e,t)},insertSectionBefore:function(e,t){return this.getSections().insertItemBefore(e,t)},appendSection:function(e){return this.getSections().appendChild(e)},hasMultipleSections:function(){return this.getSections().getChildCount()>1},calcDataRangeOfSection:function(e,t){return e.calcDataRange(t)},calcDataRangeOfSections:function(e,t){for(var a={},r=0,n=e.length;r<n;++r){var i=e[r].calcDataRange(t);a=Kekule.Spectroscopy.Utils.mergeDataRange(a,i)}return a},getDisplayRangeOfSection:function(e,t,a){return e.getDisplayRangeOfVars(t,a)},getDisplayRangeOfSections:function(e,t,a){for(var r={},n=0,i=e.length;n<i;++n){var l=e[n].getDisplayRangeOfVars(t,a);r=Kekule.Spectroscopy.Utils.mergeDataRange(r,l)}return r},getVariableCount:function(){return(this.getVariables()||[]).length},getVariable:function(e){return e instanceof Kekule.VarDefinition?e:"number"==typeof e?this.getVariables()[e]:this.getVariables()[this.getVarSymbols().indexOf(e)]},indexOfVariable:function(e){return this.getVariables().indexOf(e)},insertVariableAt:function(e,t){return t>=0?this.getVariables().splice(t,0,e):this.getVariables().push(e),this},insertVariableBefore:function(e,t){var a=t?this.indexOfVarDefinition(t):-1;return this.insertVarDefinitionAt(e,a)},appendVariable:function(e){return this.insertVariableAt(e,-1)},removeVariableAt:function(e){return this.getVariables().splice(e,1),this},removeVariable:function(e){var t=this.indexOfVariable(e);return t>=0&&this.removeVariableAt(t),this},getVariablesOfDependency:function(e){for(var t=[],a=0,r=this.getVariableCount();a<r;++a){var n=this.getVariable(a);n&&n.getDependency()===e&&t.push(n)}return t},getContinuousVarRange:function(e){var t=this.getVariable(e),a=t&&t.getInfo();return a&&a.continuous?{fromValue:a.fromValue,toValue:a.toValue}:null},setContinuousVarRange:function(e,t,a){var r=this.getVariable(e),n=r&&r.getInfo(!0);return n.continuous=!0,n.fromValue=t,n.toValue=a,this},clearContinuousVarRange:function(e){var t=this.getVariable(e).getInfo();return t&&t.continuous&&(t.continuous=!1),this},setDefaultVarValue:function(e,t){var a=this.getVariable(e);return(a&&a.getInfo(!0)).defaultValue=t,this},clearDefaultVarValue:function(e){return this.setDefaultVarValue(e,null)},getDefaultVarValue:function(e){var t=this.getVariable(e),a=t&&t.getInfo();if(a)return a.defaultValue},iterateSections:function(e){for(var t=0,a=this.getSectionCount();t<a;++t)e(this.getSectionAt(t),t)},sort:function(e){this.iterateSections(function(t){t.sort(e)})},getDataCount:function(){var e=0;return this.iterateSections(function(t){e+=t.getDataCount()}),e},clearData:function(){this.iterateSections(function(e){e.clear()})},appendData:function(e){return this.getActiveSection().appendData(e)},removeData:function(e){return this.getActiveSection().removeData(e)},removeDataAt:function(e){return this.getActiveSection().removeDataAt(e)},getRawValueAt:function(e){return this.getActiveSection().getRawValueAt(e)},getHashValueAt:function(e){return this.getActiveSection().getHashValueAt(e)},getValueAt:function(e){return this.getHashValueAt(e)},setRawValueAt:function(e,t){return this.getActiveSection().setRawValueAt(e,t),this},setHashValueAt:function(e,t,a){return this.getActiveSection().setHashValueAt(e,t,a),this},setValueAt:function(e,t,a){return this.getActiveSection().setValueAt(e,t),this},getExtraInfoOf:function(e){return this.getActiveSection().getExtraInfoOf(e)},setExtraInfoOf:function(e,t){return this.getActiveSection().setExtraInfoOf(e,t),this},getExtraInfoAt:function(e){return this.getActiveSection().getExtraInfoAt(e)},setExtraInfoAt:function(e,t){return this.getActiveSection().setExtraInfoAt(e,t),this},getDependentValues:function(e,t){return this.doGetDependentValues(independantValues,t)},doGetDependentValues:function(e,t){return{}},getIterator:function(){return this.doGetIterator()},doGetIterator:function(){var e=this.getSections().getItems();return{sectionIndex:0,index:0,next:function(){var t=this,a=function(){return t.sectionIndex>=e.length||t.sectionIndex===e.length-1&&t.index>=e[e.length-1].getDataCount()};if(a())return{done:!0};if(!(this.index<e[this.sectionIndex].getDataCount())){do{++this.sectionIndex,this.index=0}while(this.index>=e[this.sectionIndex].getDataCount()||t.sectionIndex>=e.length);return a()?{done:!0}:{done:!1,value:e[this.sectionIndex].getValueAt(this.index)}}var r={done:!1,value:e[this.sectionIndex].getValueAt(this.index)};return++this.index,r}}},forEach:function(e,t){var a=this.getIterator();if(a)for(var r=0,n=a.next();!n.done;)e.apply(t,[n.value,r]),++r,n=a.next();return this}}),Kekule.Spectroscopy.PeakShape={SHARP:"sharp",BROAD:"broad"},Kekule.Spectroscopy.PeakMultiplicity={UNKNOWN:0,SINGLET:1,DOUBLET:2,TRIPLET:3,QUARTET:4,QUINTET:5,SEXTUPLET:6,MULTIPLET:255},Kekule.Spectroscopy.SpectrumPeakDetails=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Spectroscopy.SpectrumPeakDetails",initialize:function(e){this.setPropStoreFieldValue("assignments",[]),this.tryApplySuper("initialize",[]),this.setPropValues(e)},initProperties:function(){this.defineProp("assignments",{dataType:DataType.ARRAY,objRef:!0,autoUpdate:!0,setter:function(e){var a=e?DataType.isArrayValue(e)?t.clone(e):t.toArray(e):[];this.setPropStoreFieldValue("assignments",a)}}),this.defineProp("assignment",{dataType:"Kekule.ChemObject",serializable:!1,scope:Class.PropertyScope.PUBLIC,getter:function(){return(this.getAssignments()||[])[0]},setter:function(e){this.setAssignments(e)}}),this.defineProp("shape",{dataType:DataType.STRING}),this.defineProp("multiplicity",{dataType:DataType.VARIANT})},doFinalize:function(){this.setPropStoreFieldValue("assignments",null),this.tryApplySuper("doFinalize")},getAutoIdPrefix:function(){return"p"}}),Kekule.Spectroscopy.SpectrumType={NMR:"NMR",IR:"IR",MS:"MS",UV_VIS:"UV_VIS",IMS:"IMS",RAMAN:"Raman",CHROMATOGRAPHY:"chromatography",GENERAL:"general"},Kekule.Spectroscopy.SpectrumNMR={TargetNucleus:{C13:"C13",H:"H"}},Kekule.Spectroscopy.SpectrumMS={SpectrometerType:{}},Kekule.Spectroscopy.Spectrum=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Spectroscopy.Spectrum",initialize:function(e){this.setPropStoreFieldValue("data",new Kekule.Spectroscopy.SpectrumData(null,null,this)),this.tryApplySuper("initialize",[e]),this._initDelegatedMethods()},doFinalize:function(){this.setPropStoreFieldValue("refMolecules",null);var e=this.getData();e&&e.finalize(),this.tryApplySuper("doFinalize")},initProperties:function(){this.defineProp("spectrumType",{dataType:DataType.STRING}),this.defineProp("name",{dataType:DataType.STRING}),this.defineProp("data",{dataType:"Kekule.Spectroscopy.SpectrumData",setter:function(e){var t=this.getData();e!==t&&(t&&t.finalize(),e&&e.setPropValue("parent",this,!0),this.setPropStoreFieldValue("data",e))}}),this.defineProp("refMolecules",{dataType:DataType.ARRAY,objRef:!0,autoUpdate:!0,setter:function(e){var a=e?DataType.isArrayValue(e)?t.clone(e):t.toArray(e):[];this.setPropStoreFieldValue("refMolecules",a)}}),this.defineProp("refMolecule",{dataType:"Kekule.Molecule",serializable:!1,scope:Class.PropertyScope.PUBLIC,getter:function(){return(this.getRefMolecules()||[])[0]},setter:function(e){this.setrRefMolecules(e)}}),this._defineInfoProperty("title"),this._defineInfoProperty("metaData",null,{dataType:DataType.HASH}),this._defineInfoProperty("conditions",null,{dataType:DataType.HASH}),this._defineInfoProperty("parameters",null,{dataType:DataType.HASH}),this._defineInfoProperty("annotations",null,{dataType:DataType.HASH}),this._defineDataDelegatedProperty("variables"),this._defineDataDelegatedProperty("varSymbols"),this._defineDataDelegatedProperty("dataSections","sections"),this._defineDataDelegatedProperty("activeDataSectionIndex","activeSectionIndex"),this._defineDataDelegatedProperty("activeDataSection","activeSection")},_initDelegatedMethods:function(){this._defineDataDelegatedMethod("createDataSection","createSection"),this._defineDataDelegatedMethod("clearDataSection","clearSection"),this._defineDataDelegatedMethod("getDataSectionCount","getSectionCount"),this._defineDataDelegatedMethod("getDataSectionAt","getSectionAt"),this._defineDataDelegatedMethod("indexOfDataSection","indexOfSection"),this._defineDataDelegatedMethod("hasDataSection","hasSection"),this._defineDataDelegatedMethod("removeDataSectionAt","removeSectionAt"),this._defineDataDelegatedMethod("removeDataSection","removeSection"),this._defineDataDelegatedMethod("insertDataSectionAt","insertSectionAt"),this._defineDataDelegatedMethod("insertDataSectionBefore","insertSectionBefore"),this._defineDataDelegatedMethod("appendDataSection","appendSection"),this._defineDataDelegatedMethod("iterateDataSection","iterateSection"),this._defineDataDelegatedMethod("sortData","sort"),this._defineDataDelegatedMethod("clearData"),this._defineDataDelegatedMethod("getVariableCount"),this._defineDataDelegatedMethod("getVariable"),this._defineDataDelegatedMethod("indexOfVariable"),this._defineDataDelegatedMethod("insertVariableAt"),this._defineDataDelegatedMethod("insertVariableBefore"),this._defineDataDelegatedMethod("appendVariable"),this._defineDataDelegatedMethod("removeVariableAt"),this._defineDataDelegatedMethod("removeVariable"),this._defineDataDelegatedMethod("getVariablesOfDependency"),this._defineDataDelegatedMethod("getContinuousVarRange"),this._defineDataDelegatedMethod("setContinuousVarRange"),this._defineDataDelegatedMethod("clearContinuousVarRange"),this._defineDataDelegatedMethod("getDefaultVarValue"),this._defineDataDelegatedMethod("setDefaultVarValue"),this._defineDataDelegatedMethod("clearDefaultVarValue")},_defineInfoProperty:function(e,t,a){var r;return r=Object.extend({getter:function(){return this.getInfoValue(t||e)},setter:function(a){this.setInfoValue(t||e,a)},serializable:!1},a),this.defineProp(e,r)},_defineDataDelegatedProperty:function(e,t){t||(t=e);var a=ClassEx.getPropInfo(Kekule.Spectroscopy.SpectrumData,t),r=Object.create(a);return r.getter=null,r.setter=null,r.serializable=!1,a.getter&&(r.getter=function(){return this.getData().getPropValue(t)}),a.setter&&(r.setter=function(e){this.getData().setPropValue(t,e)}),this.defineProp(e,r)},_defineDataDelegatedMethod:function(e,t){t||(t=e),ClassEx.getPrototype(this.getClass())[e]=function(){return this.getData()[t].apply(this.getData(),arguments)}},getAutoIdPrefix:function(){return"s"},ownerChanged:function(e,t){var a=this.getData();a&&a.setOwner(e),this.tryApplySuper("ownerChanged",[e,t])},getChildSubgroupNames:function(){return["dataSection"].concat(this.tryApplySuper("getChildSubgroupNames"))},getBelongChildSubGroupName:function(e){return e instanceof Kekule.Spectroscopy.SpectrumDataSection?"dataSection":this.tryApplySuper("getBelongChildSubGroupName",[e])},doGetChildCount:function(){return this.getDataSectionCount()},doGetChildAt:function(e){return this.getDataSectionAt(e)},doIndexOfChild:function(e){return this.indexOfDataSection(e)},_getInfoBasedHashPropValue:function(e,t){var a=this.getInfoValue(e);return a&&a[t]},_setInfoBasedHashpropValue:function(e,t,a){var r=this.getInfoValue(e);r||(r={},this.setInfoValue(e,r)),r[t]=a},_getAllKeysOfInfoBasedHashProp:function(e){var t=this.getInfoValue(e);return t?Kekule.ObjUtils.getOwnedFieldNames(t,!1):[]},getSpectrumInfoValue:function(e,t){t||(t=["metaData","conditions","parameters","annotations"]);for(var a=0,r=t.length;a<r;++a){var n=t[a],i=this._getInfoBasedHashPropValue(n,e);if(Kekule.ObjUtils.notUnset(i))return i}},getMeta:function(e){return this._getInfoBasedHashPropValue("metaData",e)},setMeta:function(e,t){return this._setInfoBasedHashpropValue("metaData",e,t),this},getMetaKeys:function(){return this._getAllKeysOfInfoBasedHashProp("metaData")},getCondition:function(e){return this._getInfoBasedHashPropValue("conditions",e)},setCondition:function(e,t){return this._setInfoBasedHashpropValue("conditions",e,t),this},getConditionKeys:function(){return this._getAllKeysOfInfoBasedHashProp("conditions")},getParameter:function(e){return this._getInfoBasedHashPropValue("parameters",e)},setParameter:function(e,t){return this._setInfoBasedHashpropValue("parameters",e,t),this},getParameterKeys:function(){return this._getAllKeysOfInfoBasedHashProp("parameters")},getAnnotation:function(e){return this._getInfoBasedHashPropValue("annotations",e)},setAnnotation:function(e,t){return this._setInfoBasedHashpropValue("annotations",e,t),this},getAnnotationKeys:function(){return this._getAllKeysOfInfoBasedHashProp("annotations")},getVarAvailableExternalUnitObjs:function(e){return Kekule.Spectroscopy.DataValueConverterManager.getAltUnits(e,e.getInternalUnit?e.getInternalUnit():e.getUnit(),null,this)},getVarAvailableExternalUnitSymbols:function(e){for(var t=Kekule.Spectroscopy.DataValueConverterManager.getAltUnits(e,e.getInternalUnit?e.getInternalUnit():e.getUnit(),null,this),a=[],r=0,n=t.length;r<n;++r)a.push(t[r].symbol);return a}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.Spectroscopy.Spectrum),Kekule.ClassDefineUtils.addStandardSizeSupport(Kekule.Spectroscopy.Spectrum),(r=Kekule.Unit.register)("transmittance","transmittance","OpticalTransmittance",1),r("transmittance%","transmittance_percent","OpticalTransmittance",.01),r("reflectance","reflectance","OpticalReflectance",1),r("absorbance","absorbance","OpticalAbsorbance",1),r("Kubelka Munk","Kubelka_Munk","OpticalKubelkaMunk",1),r("counts","ms_count","Misc",null),r("relative abundance","ms_relative_abundance","SpectrumMS",null),r("m/z","ms_mass_charge_ratio","SpectrumMS",null)}(),function(){"use strict";if(Kekule.Render&&Kekule.Render.ChemObj2DRenderer){Kekule.globalOptions.add("render.spectrum",{continuousSpectrumResampleRatio:1});var e=Kekule.CoordUtils,t=Kekule.ArrayUtils;Kekule.Render.SpectrumDisplayConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.SpectrumDisplayConfigs",initProperties:function(){this.addHashConfigProp("defSize2DRatio"),this.addBoolConfigProp("reversedAxises",!1),this.addBoolConfigProp("reverseIndependentDataDirection",!1),this.addBoolConfigProp("reverseDependentDataDirection",!1),this.addBoolConfigProp("reverseIndependentAxisAlign",!1),this.addBoolConfigProp("reverseDependentAxisAlign",!1),this.addStrConfigProp("dataColor","#000000"),this.addFloatConfigProp("dataStrokeWidthRatio",.025),this.addFloatConfigProp("dataStrokeWidthMin",1),this.addFloatConfigProp("visibleIndependentDataRangeFrom",0),this.addFloatConfigProp("visibleIndependentDataRangeTo",1),this.addFloatConfigProp("visibleDependentDataRangeFrom",-.05),this.addFloatConfigProp("visibleDependentDataRangeTo",1.05),this.addFloatConfigProp("visibleIndependentDataRangeFrom_Peak",-.05),this.addFloatConfigProp("visibleIndependentDataRangeTo_Peak",1.05),this.addFloatConfigProp("visibleDependentDataRangeFrom_Peak",-.05),this.addFloatConfigProp("visibleDependentDataRangeTo_Peak",1.05),this.addFloatConfigProp("visibleIndependentDataRangeFrom_Continuous",0),this.addFloatConfigProp("visibleIndependentDataRangeTo_Continuous",1),this.addFloatConfigProp("visibleDependentDataRangeFrom_Continuous",-.05),this.addFloatConfigProp("visibleDependentDataRangeTo_Continuous",1.05),this.addBoolConfigProp("displayIndependentAxis",!0),this.addBoolConfigProp("displayIndependentAxisScales",!0),this.addBoolConfigProp("displayIndependentAxisLabel",!0),this.addBoolConfigProp("displayIndependentAxisUnit",!0),this.addBoolConfigProp("displayDependentAxis",!0),this.addBoolConfigProp("displayDependentAxisScales",!0),this.addBoolConfigProp("displayDependentAxisLabel",!0),this.addBoolConfigProp("displayDependentAxisUnit",!0),this.addStrConfigProp("axisScaleLabelFontFamily","Arial, Helvetica, sans-serif"),this.addFloatConfigProp("axisScaleLabelFontSize",7),this.addStrConfigProp("axisScaleLabelColor","#000000"),this.addStrConfigProp("axisLabelFontFamily","Arial, Helvetica, sans-serif"),this.addFloatConfigProp("axisLabelFontSize",10),this.addStrConfigProp("axisLabelColor","#000000"),this.addStrConfigProp("axisColor","#000000"),this.addFloatConfigProp("axisWidthRatio",.025),this.addFloatConfigProp("axisWidthMin",1),this.addFloatConfigProp("axisScaleMarkSizeRatio",.1),this.addFloatConfigProp("axisScaleMarkSizeMin",3),this.addFloatConfigProp("axisUnlabeledScaleSizeRatio",.7),this.addIntConfigProp("axisScaleMarkPreferredCount",10),this.addFloatConfigProp("axisLabelPaddingRatio",.02),this.addFloatConfigProp("axisScaleLabelPaddingRatio",.02)},initPropDefValues:function(){this.tryApplySuper("initPropDefValues"),this.setDefSize2DRatio({x:12,y:8})},doGetPropNameToHashPrefix:function(){return"spectrum_"}}),ClassEx.extendMethod(Kekule.Render.Render2DConfigs,"initProperties",function(e){e(),this.addConfigProp("spectrumDisplayConfigs","Kekule.Render.SpectrumDisplayConfigs")}),ClassEx.extendMethod(Kekule.Render.Render2DConfigs,"initPropDefValues",function(e){e(),this.setPropStoreFieldValue("spectrumDisplayConfigs",new Kekule.Render.SpectrumDisplayConfigs)}),ClassEx.extendMethod(Kekule.Spectroscopy.Spectrum,"initPropValues",function(t){t();var a=this.getSize2D();if(!a){var r=Kekule.Render.Render2DConfigs.getInstance(),n=r.getSpectrumDisplayConfigs().getDefSize2DRatio(),i=r.getLengthConfigs().getDefScaleRefLength();n&&i&&(a=e.multiply(n,i)),this.setSize2D(a)}}),ClassEx.extendMethod(Kekule.Spectroscopy.Spectrum,"doGetObjAnchorPosition",function(e,t){return Kekule.ObjAnchorPosition.CENTER}),Kekule._registerAfterLoadSysProc(function(){var e,a,r,n,i=function(e,a,r,n,i){for(var l=t.toArray(n),s=i||[""],o=0,u=l.length;o<u;++o)for(var c=0,d=s.length;c<d;++c){var p=s[c]?s[c]+a.upperFirst():a;e.push({name:"spectrum_"+p,dataType:r,targetClass:l[o]})}};if(Kekule.PropertyEditor&&Kekule.PropertyEditor.ChemRender2DOptionsEditor){var l=ClassEx.getPrototype(Kekule.PropertyEditor.ChemRender2DOptionsEditor);l.CHILD_FIELD_INFOS=l.CHILD_FIELD_INFOS.concat((e=[],a=Kekule.Spectroscopy.Spectrum,r=Kekule.Spectroscopy.SpectrumDataSection,n=["","independent","dependent"],i(e,"reversedAxises",DataType.BOOL,a),i(e,"reverseIndependentDataDirection",DataType.BOOL,a),i(e,"reverseDependentDataDirection",DataType.BOOL,a),i(e,"reverseIndependentAxisAlign",DataType.BOOL,a),i(e,"reverseDependentAxisAlign",DataType.BOOL,a),i(e,"dataColor",DataType.STRING,[a,r]),i(e,"dataStrokeWidthRatio",DataType.FLOAT,[a,r]),i(e,"dataStrokeWidthMin",DataType.NUMBER,[a,r]),i(e,"visibleIndependentDataRangeFrom",DataType.FLOAT,a),i(e,"visibleIndependentDataRangeTo",DataType.FLOAT,a),i(e,"visibleDependentDataRangeFrom",DataType.FLOAT,a),i(e,"visibleDependentDataRangeTo",DataType.FLOAT,a),i(e,"visibleIndependentDataRangeFrom",DataType.BOOL,a),i(e,"displayIndependentAxis",DataType.BOOL,a),i(e,"displayIndependentAxisScales",DataType.BOOL,a),i(e,"displayIndependentAxisLabel",DataType.BOOL,a),i(e,"displayIndependentAxisUnit",DataType.BOOL,a),i(e,"displayDependentAxis",DataType.BOOL,a),i(e,"displayDependentAxisScales",DataType.BOOL,a),i(e,"displayDependentAxisLabel",DataType.BOOL,a),i(e,"displayDependentAxisUnit",DataType.BOOL,a),i(e,"axisScaleLabelFontFamily",DataType.STRING,a,n),i(e,"axisScaleLabelFontSize",DataType.NUMBER,a,n),i(e,"axisScaleLabelColor",DataType.STRING,a,n),i(e,"axisLabelFontFamily",DataType.STRING,a,n),i(e,"axisLabelFontSize",DataType.NUMBER,a,n),i(e,"axisLabelColor",DataType.STRING,a,n),i(e,"axisColor",DataType.STRING,a,n),i(e,"axisWidthRatio",DataType.FLOAT,a,n),i(e,"axisWidthMin",DataType.NUMBER,a,n),i(e,"axisScaleMarkSizeRatio",DataType.FLOAT,a,n),i(e,"axisScaleMarkSizeMin",DataType.NUMBER,a,n),i(e,"axisUnlabeledScaleSizeRatio",DataType.FLOAT,a,n),i(e,"axisScaleMarkPreferredCount",DataType.NUMBER,a,n),i(e,"axisLabelPaddingRatio",DataType.FLOAT,a,n),i(e,"axisScaleLabelPaddingRatio",DataType.NUMBER,a,n),e))}}),Kekule.Render.CoordAxisRender2DUtils={drawAxises:function(e,t,r,n,i,l){var s=function(e,t,a,r){for(var n=Kekule.Render.RichTextUtils,i=[],l=r?Math.round(Math.log10(a)):null,s=0,o=e.length;s<o;++s){var u,c=e[s],d=(l?c/a:c).toFixed(t);if(!l||Kekule.NumUtils.isFloatEqual(d,0))u=n.strToRichText(d);else{u=n.createGroup(null,{charDirection:Kekule.Render.TextDirection.LTR});var p=n.appendText2(u,d+"×10");n.appendText(u,l.toFixed(0),{textType:Kekule.Render.RichText.SUP,refItem:p})}i.push(u)}return i},o=!!i.abscissaDataRange,u=!!i.ordinateDataRange;if(!o&&!u)return null;var c=o&&i.abscissaScales?s(i.abscissaScales,i.abscissaScaleFixedDigitCountAfterPoint,i.abscissaScaleBase,i.abscissaScaleUseSciForm):null,d=u&&i.ordinateScales?s(i.ordinateScales,i.ordinateScaleFixedDigitCountAfterPoint,i.ordinateScaleBase,i.ordinateScaleUseSciForm):null,p=Kekule.Render.RichTextUtils,f=Object.create(i);if(o){if(f.abscissaLabel&&f.abscissaUnitLabel){var h=Kekule.Render.RichTextUtils.createGroup(null,{charDirection:Kekule.Render.TextDirection.LTR});p.append(h,f.abscissaLabel),p.appendText(h," ("),p.append(h,f.abscissaUnitLabel),p.appendText(h,")"),f.abscissaLabel=h}else f.abscissaLabel=f.abscissaLabel||f.abscissaUnitLabel;f.abscissaUnitLabel=null}if(u){if(f.ordinateLabel&&f.ordinateUnitLabel){h=Kekule.Render.RichTextUtils.createGroup(null,{charDirection:Kekule.Render.TextDirection.LTR});p.append(h,f.ordinateLabel),p.appendText(h," ("),p.append(h,f.ordinateUnitLabel),p.appendText(h,")"),f.ordinateLabel=h}else f.ordinateLabel=f.ordinateLabel||f.ordinateUnitLabel;f.ordinateUnitLabel=null}var g,S=o?a._estimateAxisSizes(e,t,r,n,c,f.abscissaUnitLabel,f.abscissaLabel,l,!0,1===f.abscissaAxisPosition):null,A=u?a._estimateAxisSizes(e,t,r,n,d,f.ordinateUnitLabel,f.ordinateLabel,l,!1,0===f.ordinateAxisPosition):null,m=e.createGroup(r),T=Object.create(n),I=Object.create(n);if(A&&(0===i.ordinateAxisPosition?T.x1+=A.total.x:T.x2-=A.total.x),S&&(1===i.abscissaAxisPosition?I.y1+=S.total.y:I.y2-=S.total.y),o){var D=c;g=a._drawSingleAxis(e,t,r,T,f.abscissaDataRange,f.abscissaScales,D,f.abscissaUnitLabel,f.abscissaLabel,S,l,!0,1===f.abscissaAxisPosition,f.abscissaReversedDirection),e.addToGroup(g,m)}if(u){D=d;g=a._drawSingleAxis(e,t,r,I,f.ordinateDataRange,f.ordinateScales,D,f.ordinateUnitLabel,f.ordinateLabel,A,l,!1,1!==f.ordinateAxisPosition,f.ordinateReversedDirection),e.addToGroup(g,m)}return{drawnElem:m,clientBox:{x1:T.x1,x2:T.x2,y1:I.y1,y2:I.y2}}},_drawSingleAxis:function(e,t,a,r,n,i,l,s,o,u,c,d,p,f){var h,g,S=Kekule.Render.BoxXAlignment,A=Kekule.Render.BoxYAlignment,m=e.createGroup(a),T=p,I=d?"x":"y",D=d?"y":"x",R=(d?c.abscissa:c.ordinate)||c,y={x:r.x2-r.x1,y:r.y2-r.y1},_={x:r.x1,y:r.y1},L=d?!f:f,E={},O={},v=0;o&&(E[I]=_[I]+y[I]/2-u.axisLabel[I]/2*(d?1:-1),E[D]=_[D]+(T?u.axisLabelPadding[D]+u.axisLabel[D]/2:y[D]-(u.axisLabelPadding[D]+u.axisLabel[D]/2)),h=Object.extend(Object.extend({},R.axisLabel),{textBoxXAlignment:S.LEFT,textBoxYAlignment:A.CENTER}),d||(h.transforms=[{rotate:-Math.PI/2,center:Object.extend({},E)}]),g=t.drawEx(a,E,o,h).drawnObj,e.addToGroup(g,m),v+=u.axisLabel[D]+2*u.axisLabelPadding[D]);var C=Object.create(R.axis);if(C.strokeColor||(C.strokeColor=C.color),C.fillColor||(C.fillColor=C.color),i&&l){var N=n.max-n.min,b=d?{textBoxXAlignment:S.LEFT,textBoxYAlignment:T?A.BOTTOM:A.TOP}:{textBoxXAlignment:S.LEFT,textBoxYAlignment:A.CENTER};h=Object.extend(Object.create(R.scaleLabel),b),E[D]=T?_[D]+v+u.scaleLabel[D]+u.scaleLabelPadding[D]:_[D]+y[D]-v-u.scaleLabel[D]-u.scaleLabelPadding[D];var P={};P[D]=E[D];for(var V=y[I]/(l.length-1),M=V,x=1;M<u.scaleLabel[I];)++x,M+=V;for(var k=0,U=i.length;k<U;++k){var F=(L?i[k]-n.min:n.max-i[k])/N*y[I]+_[I];E[I]=F;var K=!1;if(k%x==0){if(P[I]=E[I],d){var B=t.measure(a,P,l[k],h);P.x=E.x-B.width/2}else if(T){B=t.measure(a,P,l[k],h);P.x=E.x-B.width}g=t.drawEx(a,P,l[k],h).drawnObj,e.addToGroup(g,m),K=!0}var G={x:E.x,y:E.y},w=u.scaleMark[D];G[D]+=(w+u.scaleLabelPadding[D])*(p?1:-1),K||(w*=C.unlabeledScaleSizeRatio||1),O[I]=F,O[D]=G[D]-w*(p?1:-1),g=e.drawLine(a,G,O,C),e.addToGroup(g,m)}v+=u.scaleLabel[D]+2*u.scaleLabelPadding[D]+u.scaleMark[D]}return E[I]=_[I],E[D]=T?_[D]+v+u.axis[D]/2:_[D]+y[D]-v-u.axis[D]/2,O[I]=E[I]+y[I],O[D]=E[D],g=e.drawLine(a,E,O,Object.extend({lineCap:"square"},C)),e.addToGroup(g,m),m},_estimateAxisSizes:function(e,t,a,r,n,i,l,s,o,u){var c=(o?s.abscissa:s.ordinate)||s,d={x:0,y:0},p={x:0,y:0};if(n&&n.length){var f=n[0],h=n[n.length-1],g=t.measure(a,{x:0,y:0},f,c.scaleLabel),S=t.measure(a,{x:0,y:0},h,c.scaleLabel);d={x:Math.max(g.width,S.width),y:Math.max(g.height,S.height)},p={x:c.scaleLabel.padding||0,y:c.scaleLabel.padding||0}}var A={x:0,y:0};if(i){var m=t.measure(a,{x:0,y:0},i,c.unitLabel);A.x=Math.max(d.x,m.width),A.y=Math.max(d.y,m.height)}var T={x:0,y:0},I={x:0,y:0};if(l){var D=t.measure(a,{x:0,y:0},l,c.axisLabel);T=o?{x:D.width,y:D.height}:{y:D.width,x:D.height},I={x:c.axisLabel&&c.axisLabel.padding||0,y:c.axisLabel&&c.axisLabel.padding||0}}var R=c.axis,y=o?{x:0,y:R.scaleMarkSize}:{x:R.scaleMarkSize,y:0},_=o?{x:0,y:R.strokeWidth}:{x:R.strokeWidth,y:0},L={};return o?(L.x=r.x2-r.x1,L.y=d.y+T.y+_.y+y.y+2*p.y+2*I.y):(L.y=r.y2-r.y1,L.x=d.x+T.x+_.x+y.x+2*p.x+2*I.x),{total:L,axis:_,scaleMark:y,scaleLabel:d,scaleLabelPadding:p,unitLabel:A,axisLabel:T,axisLabelPadding:I}}};var a=Kekule.Render.CoordAxisRender2DUtils;Kekule.Render.Spectrum2DRenderUtils={_getDataDefaultAxisDirection:function(e,t,a){var r=Kekule.Spectroscopy.SpectrumType,n=Kekule.Unit,i=!0;return e===r.NMR&&t&&(i=!1),e===r.IR&&t&&a===n.Frequency.WAVE_NUMBER&&(i=!1),i},_getDataDefaultAxisAlign:function(e,t,a){Kekule.Spectroscopy.SpectrumType,Kekule.Unit;return!0},getDefaultAxisDirectionAndAlignInfo:function(e,t,a){return{reversedDirection:!Kekule.Render.Spectrum2DRenderUtils._getDataDefaultAxisDirection(e,t,a),reversedAlign:!Kekule.Render.Spectrum2DRenderUtils._getDataDefaultAxisAlign(e,t,a)}}},Kekule.Render.Spectrum2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.Spectrum2DRenderer",initialize:function(e,t,a){this.tryApplySuper("initialize",[e,t,a]),this._initSectionDataDrawerMap()},_initSectionDataDrawerMap:function(){Kekule.Render.Spectrum2DRenderer.sectionDataDrawerMap[Kekule.Spectroscopy.DataMode.CONTINUOUS]=this.doDrawContinuousSectionData,Kekule.Render.Spectrum2DRenderer.sectionDataDrawerMap[Kekule.Spectroscopy.DataMode.PEAK]=this.doDrawPeakSectionData},_initSpectrumDefSize:function(t,a){if(!t.getSize2D()){var r=e.multiply(a.spectrum_defSize2DRatio,a.defScaleRefLength*(a.unitLength||1));t.setSize2D(r)}},doDrawSelf:function(e,t,a){this.tryApplySuper("doDrawSelf",[e,t,a]);var r=this.getChemObj();t||(t=this.getAutoBaseCoord(a)),this._initSpectrumDefSize(r,a);var n,i=r.getExposedContainerBox(),l={x:i.x1,y:i.y2},s={x:i.x2,y:i.y1},o=this.transformCoordToContext(e,r,l),u=this.transformCoordToContext(e,r,s),c=Kekule.CoordUtils.substract(u,o),d={x:t.x-c.x/2,y:t.y-c.y/2},p=d,f=Kekule.CoordUtils.add(d,c),h=Kekule.BoxUtils.createBox(p,f),g=this._getActualRenderOptions(e,r,a),S=this.doGetTargetDataSections(r);if(S&&S.length){var A=this.doGetDataVarInfos(S);if(A){var m=this._getDisplayRangeOfSections(r,r.getData(),S,A,g),T=A.varSymbols;if(Kekule.NumUtils.isFloatEqual(m[T.independant].min,m[T.independant].max)||Kekule.NumUtils.isFloatEqual(m[T.dependant].min,m[T.dependant].max))return Kekule.error(Kekule.$L("ErrorMsg.VISIBLE_DATA_RANGE_IS_EMPTY")),null;var I,D=this._getAxisDirectionAndAlignInfo(e,r,m,T,A.varUnitSymbols,g);n=this.createDrawGroup(e);var R=this._prepareAxisRenderParamsAndOptions(this.getActualTargetContext(e),r,m,T,g,D),y=Kekule.Render.CoordAxisRender2DUtils.drawAxises(this.getDrawBridge(),this.getRichTextDrawer(),this.getActualTargetContext(e),h,R.drawParams,R.renderOptions);y?(this.addToDrawGroup(y.drawnElem,n),I=y.clientBox):I=h;var _=this.doCalcSprectrumTransformMatrix(r,S,T,m,I,g,D),L=this.doDrawDataSections(r,S,T,e,i,I,_,m,g);L&&this.addToDrawGroup(L,n),this.basicDrawObjectUpdated(e,r,r,this.createRectBoundInfo(p,f),Kekule.Render.ObjectUpdateType.ADD)}}return n},_getActualRenderOptions:function(e,t,a){var r=t.getData().getSections().getRenderOptions(),n=Object.create(a);return n=Object.extend(n,r)},_getAxisDirectionAndAlignInfo:function(e,t,a,r,n,i){var l=t.getSpectrumType(),s=Kekule.Render.Spectrum2DRenderUtils.getDefaultAxisDirectionAndAlignInfo(l,!0,n.independant),o=Kekule.Render.Spectrum2DRenderUtils.getDefaultAxisDirectionAndAlignInfo(l,!1,n.dependant);return i.spectrum_reverseIndependentDataDirection&&(s.reversedDirection=!s.reversedDirection),i.spectrum_reverseIndependentAxisAlign&&(s.reversedAlign=!s.reversedAlign),i.spectrum_reverseDependentDataDirection&&(o.reversedDirection=!o.reversedDirection),i.spectrum_reverseDependentAxisAlign&&(o.reversedAlign=!o.reversedAlign),{independent:s,dependent:o}},_prepareAxisRenderParamsAndOptions:function(e,t,a,r,n,i){var l=n,s=l.spectrum_reversedAxises,o=s?l.contextRefLengthes.y:l.contextRefLengthes.x,u=s?l.contextRefLengthes.x:l.contextRefLengthes.y,c=l.unitLength,d=Kekule.oneOf,p={},f={},h=this,g=function(e,t){var a=Object.create(e);return a=Object.extend(a,t)},S=function(e,t,a){return d(e["spectrum_"+a+t.upperFirst()],e["spectrum_"+t])},A=function(e,t,a,r,n){var i=d(e["spectrum_"+a+t.upperFirst()+"Ratio"],e["spectrum_"+t+"Ratio"]),l=d(e["spectrum_"+a+t.upperFirst()+"Min"],e["spectrum_"+t+"Min"]);return(l?Math.max(i*r,l):i*r)*n},m=function(e,t,a,r){e[a+t.upperFirst()]=r},T=function(e,t){var a=e.getVariable(t),r=a.getDisplayLabel()||a.getName();return r?DataType.isObjectValue(r)?r:Kekule.Render.RichTextUtils.strToRichText(r):null},I=function(e,t){var a,r=e.getVariable(t),n=h.doGetVarDefUnit(r);if(n){var i=Kekule.Unit.getUnit(n);return i?i.symbolHtml?a=Kekule.Render.RichTextUtils.fromSimpleHtmlCode(i.symbolHtml):i.getKey()&&(a=Kekule.Render.RichTextUtils.strToRichText(i.getKey())):a=DataType.isObjectValue(n)?n:Kekule.Render.RichTextUtils.strToRichText(n),a}return null},D=s?"abscissa":"ordinate",R=s?"ordinate":"abscissa",y={},_={};if(l.spectrum_displayIndependentAxis){if(s?p.ordinate=y:p.abscissa=y,y.axis=g(l,{strokeWidth:A(l,"axisWidth","independent",o,c),scaleMarkSize:0,color:d(S(l,"axisColor","independent"),l.color)}),(l.spectrum_displayIndependentAxisLabel||l.spectrum_displayIndependentAxisUnit)&&(y.axisLabel=g(l,{fontFamily:S(l,"axisLabelFontFamily","independent"),fontSize:S(l,"axisLabelFontSize","independent")*c,color:S(l,"axisLabelColor","independent"),padding:A(l,"axisLabelPadding","independent",o,c)})),l.spectrum_displayIndependentAxisScales&&(y.scaleLabel=g(l,{fontFamily:S(l,"axisScaleLabelFontFamily","independent"),fontSize:S(l,"axisScaleLabelFontSize","independent")*c,color:d(S(l,"axisScaleLabelColor","independent"),l.color),padding:A(l,"axisScaleLabelPadding","independent",o,c)}),y.axis.scaleMarkSize=A(l,"axisScaleMarkSize","independent",o,c),y.axis.unlabeledScaleSizeRatio=S(l,"axisUnlabeledScaleSizeRatio","independent")),m(f,"dataRange",R,a[r.independant]),m(f,"axisPosition",R,i.independent.reversedAlign?1:0),m(f,"reversedDirection",R,i.independent.reversedDirection),l.spectrum_displayIndependentAxisScales){var L=S(l,"axisScaleMarkPreferredCount","independent");m(f,"scales",R,(E=Kekule.Spectroscopy.Utils.calcScalePointInfo(a[r.independant].min,a[r.independant].max,L)).scaleValues),m(f,"scaleBase",R,E.scaleBase),m(f,"scaleUseSciForm",R,E.useSciForm),m(f,"scaleFixedDigitCountAfterPoint",R,E.fixDigitsCountAfterPoint)}l.spectrum_displayIndependentAxisLabel&&m(f,"label",R,T(t,r.independant)),l.spectrum_displayIndependentAxisUnit&&m(f,"unitLabel",R,I(t,r.independant))}if(l.spectrum_displayDependentAxis){if(s?p.abscissa=_:p.ordinate=_,_.axis=g(l,{strokeWidth:A(l,"axisWidth","dependent",u,c),scaleMarkSize:0,color:d(S(l,"axisColor","dependent"),l.color)}),(l.spectrum_displayDependentAxisLabel||l.spectrum_displayDependentAxisUnit)&&(_.axisLabel=g(l,{fontFamily:S(l,"axisLabelFontFamily","dependent"),fontSize:S(l,"axisLabelFontSize","dependent")*c,color:S(l,"axisLabelColor","dependent"),padding:A(l,"axisLabelPadding","dependent",u,c)})),l.spectrum_displayDependentAxisScales&&(_.scaleLabel=g(l,{fontFamily:S(l,"axisScaleLabelFontFamily","dependent"),fontSize:S(l,"axisScaleLabelFontSize","dependent")*c,color:d(S(l,"axisScaleLabelColor","dependent"),l.color),padding:A(l,"axisScaleLabelPadding","dependent",u,c)}),_.axis.scaleMarkSize=A(l,"axisScaleMarkSize","dependent",u,c),_.axis.unlabeledScaleSizeRatio=S(l,"axisUnlabeledScaleSizeRatio","dependent")),m(f,"dataRange",D,a[r.dependant]),m(f,"axisPosition",D,i.dependent.reversedAlign?1:0),m(f,"reversedDirection",D,i.dependent.reversedDirection),l.spectrum_displayDependentAxisScales){var E;L=S(l,"axisScaleMarkPreferredCount","dependent");m(f,"scales",D,(E=Kekule.Spectroscopy.Utils.calcScalePointInfo(a[r.dependant].min,a[r.dependant].max,L)).scaleValues),m(f,"scaleBase",D,E.scaleBase),m(f,"scaleUseSciForm",D,E.useSciForm),m(f,"scaleFixedDigitCountAfterPoint",D,E.fixDigitsCountAfterPoint)}l.spectrum_displayDependentAxisLabel&&m(f,"label",D,T(t,r.dependant)),l.spectrum_displayDependentAxisUnit&&m(f,"unitLabel",D,I(t,r.dependant))}return{renderOptions:p,drawParams:f}},doGetTargetDataSections:function(e){return[e.getActiveDataSection()]},doGetDataVarInfos:function(e){for(var t={},a={},r=0,n=e[0].getActualLocalVarInfos().length;r<n;++r){var i=e[0].getLocalVarDef(r);if(i.getDependency()===Kekule.VarDependency.DEPENDENT?(a.dependant=i.getSymbol(),t.dependant=this.doGetVarDefUnit(i)):(a.independant=i.getSymbol(),t.independant=this.doGetVarDefUnit(i)),a.dependant&&a.independant)break}return a.dependant&&a.independant?{varSymbols:a,varUnitSymbols:t}:null},doGetVarDefUnit:function(e){return e.getActualExternalUnit&&e.getActualExternalUnit()||e.getUnit()},doCalcSprectrumTransformMatrix:function(t,a,r,n,i,l,s){var o=r.dependant,u=r.independant,c=n;if(c[o]&&c[u]){var d,p;s.independent.reversedDirection&&(l.spectrum_reversedAxises?p=!0:d=!0),s.dependent.reversedDirection&&(l.spectrum_reversedAxises?d=!0:p=!0);var f=l.spectrum_reversedAxises?[{y:c[u].min,x:c[o].min},{y:c[u].max,x:c[o].max}]:[{x:c[u].min,y:c[o].min},{x:c[u].max,y:c[o].max}],h=Kekule.BoxUtils.createBox(f[0],f[1]),g={translateX:d?-h.x2:-h.x1,translateY:p?-h.y1:-h.y2},S=Kekule.CoordUtils.calcTransform2DMatrix(g),A={scaleX:(i.x2-i.x1)/(h.x2-h.x1),scaleY:-(i.y2-i.y1)/(h.y2-h.y1),translateX:i.x1,translateY:i.y1};d&&(A.scaleX=-A.scaleX),p&&(A.scaleY=-A.scaleY);var m=S=Kekule.MatrixUtils.multiply(e.calcTransform2DMatrix(A),S);return l.spectrumDataTransformMatrix=m,m}},_getDisplayRangeOfSections:function(e,t,a,r,n){for(var i=function(e,t,a,r,n){var i=r===Kekule.Spectroscopy.DataMode.PEAK?"_Peak":r===Kekule.Spectroscopy.DataMode.CONTINUOUS?"_Continuous":"",l=a?"dependent":"independent",s=n["spectrum_visible"+l.upperFirst()+"DataRangeFrom"+i]||0,o=n["spectrum_visible"+l.upperFirst()+"DataRangeTo"+i]||1,u=e;if(0!==s||1!==o){var c=(u.max-u.min)*s+u.min,d=(u.max-u.min)*(o-1)+u.max;return{min:Math.min(c,d),max:Math.max(c,d)}}return u},l=r.varSymbols.independant,s=r.varSymbols.dependant,o={},u={},c=0,d=a.length;c<d;++c){var p=t.getDisplayRangeOfSection(a[c],null,{autoCalc:!0});u[l]=i(p[l],0,!1,a[c].getMode(),n),u[s]=i(p[s],0,!0,a[c].getMode(),n),o=Kekule.Spectroscopy.Utils.mergeDataRange(o,u)}return o},_clipDataValuePairInsideVisibleRange:function(t,a,r,n){var i=[e.create(t[r.independant],t[r.dependant]),e.create(a[r.independant],a[r.dependant])],l=[e.create(n[r.independant].min,n[r.dependant].min),e.create(n[r.independant].max,n[r.dependant].max)],s=Kekule.GeometryUtils.clipLineSegmentByBox(i,l);if(s){var o={},u={};return o[r.independant]=s[0].x,o[r.dependant]=s[0].y,u[r.independant]=s[1].x,u[r.dependant]=s[1].y,[o,u]}return null},doDrawDataSections:function(e,t,a,r,n,i,l,s,o){for(var u=this.createDrawGroup(r),c=0,d=t.length;c<d;++c){var p=this.doDrawSectionData(e,t[c],r,i,o,a,l,s);p&&this.addToDrawGroup(p,u)}return u},_mergeParentAndLocalSpectrumDataRenderOptions:function(e,t){var a=Kekule.oneOf,r=e.contextRefLengthes.xy,n=a(t.unitLength,e.unitLength,1),i=a(t.spectrum_dataStrokeWidthRatio,e.spectrum_dataStrokeWidthRatio)||0,l=a(t.spectrum_dataStrokeWidthMin,e.spectrum_dataStrokeWidthMin)||0,s=(Math.max(i*r,l)||a(t.strokeWidth,e.strokeWidth,1))*n,o=Object.create(e);return o=Object.extend(o,{strokeColor:a(t.spectrum_dataColor,t.color,e.spectrum_dataColor,e.color),strokeWidth:s})},_prepareSectionDataActualRenderOptions:function(e,t,a,r){var n=r,i=t.getRenderOptions()||{};return this._mergeParentAndLocalSpectrumDataRenderOptions(n,i)},_getSpectrumDataValueItemRenderOptions:function(e,t,a){var r=t.getExtraInfoOf(a);return r&&r.renderOptions},doDrawSectionData:function(e,t,a,r,n,i,l,s){if(t.getDataCount()<=0)return null;Object.create(n);var o=t.getMode(),u=Kekule.Render.Spectrum2DRenderer.sectionDataDrawerMap[o],c=this._prepareSectionDataActualRenderOptions(e,t,a,n);return u&&u.apply(this,[e,t,a,r,c,i,l,s])},doDrawPeakSectionData:function(e,t,a,r,n,i,l,s){var o,u=this,c=function(e,t){var a=u._clipDataValuePairInsideVisibleRange(e,t,i,s);return a?[u._calcSectionDataValueContextCoord(a[0],i,l,n.spectrum_reversedAxises),u._calcSectionDataValueContextCoord(a[1],i,l,n.spectrum_reversedAxises)]:null},d=[],p=[],f=[];if(t.forEach(function(r,l){var s=t.getPeakRootValueOf(r);if(s&&r){!function(e,t,a){var r=t[t.length-1];t.length>1&&Kekule.NumUtils.isFloatEqual(r[a.dependant],e[a.dependant])?r[a.independant]=e[a.independant]:t.push(e)}(s,p,i);var o=c(s,r);if(o){var h=u._getSpectrumDataValueItemRenderOptions(e,t,r);if(h){h=u._mergeParentAndLocalSpectrumDataRenderOptions(n,h);var g=u.drawLine(a,o[0],o[1],h);f.push(g)}else{var S=function(e){var t=[];if(e&&e.length>1){var a=e[0];t.push("M"),t.push([a.x,a.y]);for(var r=1,n=e.length;r<n;++r)t.push("L"),t.push([e[r].x,e[r].y])}return t}(o);S&&S.length&&(d=d.concat(S))}}}}),p.length>1){2===p.length&&(p[0][i.independant]=s[i.independant].min,p[1][i.independant]=s[i.independant].max);for(var h=1,g=p.length;h<g;++h){var S=c(p[h-1],p[h]);S&&(d.push("M"),d.push([S[0].x,S[0].y]),d.push("L"),d.push([S[1].x,S[1].y]))}}if(d&&d.length){var A=Kekule.Render.DrawPathUtils.makePath.apply(this,d);f.unshift(this.drawPath(a,A,n))}if(f.length<1)o=null;else if(1===f.length)o=f[0];else{o=this.createDrawGroup(a);for(h=0,g=f.length;h<g;++h)this.addToDrawGroup(f[h],o)}return o},doDrawContinuousSectionData:function(t,a,r,n,i,l,s,o){var u,c=Object.create(i);c.lineCap="round";for(var d,p,f,h=this,g=function(e,t,a,r){for(var n=[],i=0,l=e.length;i<l;++i){var s=h._calcSectionDataValueContextCoord(e[i],t,a,r);n.push(s)}return n},S=Kekule.globalOptions.render.spectrum.continuousSpectrumResampleRatio||1,A=Math.abs(n.x2-n.x1)*S,m=(o[l.independant].max-o[l.independant].min)/A,T=function(e){return Math.floor((e[l.independant]-o[l.independant].min)/m)},I=[],D=null,R=[],y=[e.create(n.x1,n.y1),e.create(n.x2,n.y2)],_=0,L=a.getDataCount();_<L;++_){var E=a.getHashValueAt(_),O=E[l.independant];if(!(O<o[l.independant].min||O>o[l.independant].max)){var v=T(E);if(null===D&&(D=v),_==L-1||v!==D){if(_===L-1&&R.push(E),R.length){var C=this._getMergeSectionDataTypicalValues(R,l);if(R=[],D=v,_<L-1&&R.push(E),!C)continue;var N=(f=C,h._clipDataValuePairInsideVisibleRange(f[0],f[1],l,o)),b=null,P=null,V=null;if(N){var M=g(N,l,s,i.spectrum_reversedAxises);if(b=M,d)P=[d[d.length-1],M[0]];else if(p){var x=p[p.length-1],k=this._calcSectionDataValueContextCoord(x,l,s,i.spectrum_reversedAxises);V=Kekule.GeometryUtils.clipLineSegmentByBox([k,M[0]],y)}d=b}else{if(d){var U=C[0];if(U){var F=this._calcSectionDataValueContextCoord(U,l,s,i.spectrum_reversedAxises);V=Kekule.GeometryUtils.clipLineSegmentByBox([d[d.length-1],F],y)}}d=null}if(p=C,b&&b.length>1){I.push("M"),I.push([b[0].x,b[0].y]);for(var K=1,B=b.length;K<B;++K)I.push("L"),I.push(b[K].x,b[K].y)}P&&(I.push("M"),I.push([P[0].x,P[0].y]),I.push("L"),I.push([P[1].x,P[1].y])),V&&(I.push("M"),I.push([V[0].x,V[0].y]),I.push("L"),I.push([V[1].x,V[1].y]))}}else R.push(E)}}if(I.length){var G=Kekule.Render.DrawPathUtils.makePath.apply(this,I);u=this.drawPath(r,G,c)}return u},_getMergeSectionDataTypicalValues:function(e,t){for(var a,r,n,i,l,s,o,u,c,d=Kekule.NumUtils.isNormalNumber,p=0;p<e.length;++p){var f=e[p][t.independant];d(f)&&(d(n)||(n=f),l=f),d(f=e[p][t.dependant])&&((!d(a)||a>f)&&(a=f,(s={})[t.independant]=l,s[t.dependant]=f,u=p),(!d(r)||r<f)&&(r=f,(o={})[t.independant]=l,o[t.dependant]=f,c=p))}if(i=l,d(n)&&d(i)&&d(a)&&d(r)){var h={},g={};return u<c?(h[t.independant]=n,h[t.dependant]=a,g[t.independant]=i,g[t.dependant]=r):(h[t.independant]=n,h[t.dependant]=r,g[t.independant]=i,g[t.dependant]=a),[h,g]}return null},_calcSectionDataValueContextCoord:function(e,t,a,r){var n=r?{y:e[t.independant],x:e[t.dependant]}:{x:e[t.independant],y:e[t.dependant]};return Kekule.NumUtils.isNormalNumber(n.x)&&Kekule.NumUtils.isNormalNumber(n.y)?Kekule.CoordUtils.transform2DByMatrix(n,a):null}}),Kekule.Render.Spectrum2DRenderer.sectionDataDrawerMap={},Kekule.Render.Renderer2DFactory.register(Kekule.Spectroscopy.Spectrum,Kekule.Render.Spectrum2DRenderer)}}(),function(){"use strict";Kekule.ArrayUtils;Kekule.globalOptions.add("IO.jcamp",{}),Kekule.IO.Jcamp={};var e=Kekule.IO.Jcamp;Kekule.IO.Jcamp.Consts={DATA_LABEL_FLAG:"##",DATA_LABEL_TERMINATOR:"=",PRIVATE_LABEL_PREFIX:"$",SPECIFIC_LABEL_PREFIX:".",LABEL_BLOCK_BEGIN:"TITLE",LABEL_BLOCK_END:"END",INLINE_COMMENT_FLAG:"$$",TABLE_LINE_CONTI_MARK:"=",UNKNOWN_VALUE:NaN,LABEL_DX_VERSION:"JCAMPDX",LABEL_CS_VERSION:"JCAMPCS",DATA_FORMAT_GROUP_LEADING:"(",DATA_FORMAT_GROUP_TAILING:")",DATA_FORMAT_LOOP:"..",DATA_FORMAT_INC:"++",DATA_FORMAT_SYMBOL_ASSIGNMENT:"A",DATA_FORMAT_PLOT_DESCRIPTOR_DELIMITER:",",SIMPLE_VALUE_DELIMITER:",",DATA_VARLIST_FORMAT_XYDATA:1,DATA_VARLIST_FORMAT_XYPOINTS:2,DATA_VARLIST_FORMAT_VAR_GROUPS:3,GROUPED_VALUE_GROUP_DELIMITER:/[;\s]/g,GROUPED_VALUE_ITEM_DELIMITER:/,/g,GROUPED_VALUE_STR_ENCLOSER_LEADING:"<",GROUPED_VALUE_STR_ENCLOSER_TAILING:">",GROUPED_VALUE_EXPLICIT_GROUP_LEADING:"(",GROUPED_VALUE_EXPLICIT_GROUP_TAILING:")",VALUE_STR_EXPLICIT_QUOTE:'"'};var t=Kekule.IO.Jcamp.Consts;Kekule.IO.Jcamp.Format={DX:"dx",CS:"cs"},Kekule.IO.Jcamp.BlockType={DATA:0,LINK:1},Kekule.IO.Jcamp.DigitCharType={ASCII:1,PAC:2,SQZ:3,DIF:4,DUP:5,_DECIMAL_POINT:9,_ABNORMAL_VALUE:19};var a=Kekule.IO.Jcamp.DigitCharType;Kekule.IO.Jcamp.Utils={compareFloat:function(e,t,a){return Kekule.ObjUtils.isUnset(a)&&(a=.01*Math.min(Math.abs(e),Math.abs(t))),Kekule.NumUtils.compareFloat(e,t,a)},standardizeLdrLabelName:function(e){return e.replace(/[\/\\\-\_\s]/g,"").toUpperCase()},ldrLabelNameEqual:function(e,t){return r.standardizeLdrLabelName(e)===r.standardizeLdrLabelName(t)},analysisLdrLabelName:function(e){var a;a=e.startsWith(t.SPECIFIC_LABEL_PREFIX)?{coreName:r.standardizeLdrLabelName(e.substr(t.SPECIFIC_LABEL_PREFIX.length)),labelType:i.SPECIFIC,labelCategory:l.ANNOTATION}:e.startsWith(t.PRIVATE_LABEL_PREFIX)?{coreName:r.standardizeLdrLabelName(e.substr(t.PRIVATE_LABEL_PREFIX.length)),labelType:i.PRIVATE,labelCategory:l.ANNOTATION}:{coreName:e,labelType:i.GLOBAL,labelCategory:l.META};var n=s.getInfo(a.coreName,a.labelType);return n&&(a.dataType=n.dataType,a.labelCategory=n.labelCategory),a},getFirstNonemptyLine:function(e){var t,a=0;do{t=(e[a]||"").trim(),++a}while(!t&&a<e.length);return t||""},getAsdfDigitInfo:function(e){var t={};return"?"===e?(t.digitType=a._ABNORMAL_VALUE,t.value=null,t.sign=1):"."===e?(t.digitType=a._DECIMAL_POINT,t.value=0,t.sign=1):e>="0"&&e<="9"?(t.digitType=a.ASCII,t.value=e.charCodeAt(0)-"0".charCodeAt(0),t.sign=1):"+"===e?(t.digitType=a.PAC,t.value=0,t.sign=1):"-"===e?(t.digitType=a.PAC,t.value=0,t.sign=-1):"@"===e?(t.digitType=a.SQZ,t.value=0,t.sign=1):e>="A"&&e<="I"?(t.digitType=a.SQZ,t.value=e.charCodeAt(0)-"A".charCodeAt(0)+1,t.sign=1):e>="a"&&e<="i"?(t.digitType=a.SQZ,t.value=e.charCodeAt(0)-"a".charCodeAt(0)+1,t.sign=-1):"%"===e?(t.digitType=a.DIF,t.value=0,t.sign=1):e>="J"&&e<="R"?(t.digitType=a.DIF,t.value=e.charCodeAt(0)-"J".charCodeAt(0)+1,t.sign=1):e>="j"&&e<="r"?(t.digitType=a.DIF,t.value=e.charCodeAt(0)-"j".charCodeAt(0)+1,t.sign=-1):e>="S"&&e<="Z"?(t.digitType=a.DUP,t.value=e.charCodeAt(0)-"S".charCodeAt(0)+1,t.sign=1):"s"===e?(t.digitType=a.DUP,t.value=9,t.sign=1):(t.digitType=null,t.value=null),t},_calcAsdfNumber:function(e){for(var t,r=1,n=0,i=1,l=0,s=e.length-1;s>=0;--s){var o=e[s];if(o.digitType===a._DECIMAL_POINT){if(i=r,++l>1)return null}else n+=o.value*r,r*=10,t=o.digitType}return{value:n*=e[0].sign/i,digitType:t}},_pushAsdfNumberToSeq:function(e,n,i){var l={seq:e,lastValueType:n.digitType};if(n.digitType===a._ABNORMAL_VALUE)e.push(t.UNKNOWN_VALUE);else if(n.digitType===a.ASCII||n.digitType===a.PAC||n.digitType===a.SQZ)e.push(n.value);else{if(!e.length)return!1;var s=e[e.length-1];if(n.digitType===a.DIF)e.push(s+n.value);else{if(n.digitType!==a.DUP)return!1;if(i.digitType===a.PAC||i.digitType===a.DUP||!i.digitType)return!1;for(var o=1;o<n.value;++o)l=r._pushAsdfNumberToSeq(e,i,null);i&&(l.lastValueType=i.digitType)}}return l},decodeAsdfLine:function(e){for(var t=[],n=[],i=null,l=function(t,a,n){if(a.length){var i,l=r._calcAsdfNumber(a);return l&&(i=r._pushAsdfNumberToSeq(t,l,n)),l&&i||Kekule.error(Kekule.$L("ErrorMsg.JCAMP_ASDF_FORMAT_ERROR_WITH_STR").format(e)),t.__$lastValueType__=i.lastValueType,l}},s=0,o=e.length;s<o;++s){var u=r.getAsdfDigitInfo(e.charAt(s));u.digitType?u.digitType===a._ABNORMAL_VALUE?(i=l(t,n,i),l(t,[u],null),n=[]):u.digitType===a._DECIMAL_POINT?n.push(u):u.digitType===a.ASCII?n.push(u):(i=l(t,n,i),n=[u]):(i=l(t,n,i),n=[])}return i=l(t,n,i),t},decodeAsdfTableLines:function(e,n){for(var i,l=n||{},s=[],o=[],u=!1,c=!1,d=function(e,t,a,r){if(r){var n=e[e.length-1];if(n&&n.length){var i=n[n.length-1],l=t[1];"number"==typeof i&&Kekule.ObjUtils.notUnset(i)&&"number"==typeof l&&Kekule.ObjUtils.notUnset(l)&&(Kekule.NumUtils.isFloatEqual(i,l)?n.pop():Kekule.error(Kekule.$L("ErrorMsg.JCAMP_DATA_TABLE_Y_VALUE_CHECK_ERROR")))}}a&&p(t,e[e.length-1]),e.push(t)},p=function(e,t){if(e&&t){var a=(e[0]-t[0])/(t.length-1);i?0!==r.compareFloat(a,i)&&Kekule.error(Kekule.$L("ErrorMsg.JCAMP_DATA_TABLE_X_VALUE_CHECK_ERROR")):i=a}return!0},f=0,h=e.length;f<h;++f){var g=e[f].trim();if(g){var S=g.endsWith(t.TABLE_LINE_CONTI_MARK);S&&(g=g.substr(0,g.length-t.TABLE_LINE_CONTI_MARK.length));var A=r.decodeAsdfLine(g);o=u?o.concat(A):A,(u=S)||(d(s,o,l.doValueCheck,l.doValueCheck&&c),o=[]),c=A.__$lastValueType__===a.DIF}}return o.length&&d(s,o,l.doValueCheck,l.doValueCheck&&c),s},decodeAffnGroupLine:function(e){var a=1,r=2,n=3,i=11,l=12,s=21,o=22,u=30,c=e.trim();c.startsWith(t.GROUPED_VALUE_EXPLICIT_GROUP_LEADING)&&c.endsWith(t.GROUPED_VALUE_EXPLICIT_GROUP_TAILING)&&(c=c.substr(t.GROUPED_VALUE_EXPLICIT_GROUP_LEADING.length,c.length-t.GROUPED_VALUE_EXPLICIT_GROUP_LEADING.length-t.GROUPED_VALUE_EXPLICIT_GROUP_TAILING.length));for(var d={tokenType:null,text:""},p=[],f=[],h=function(e){var t,r,n;return(e||d.text)&&(r=d.text,n=d.tokenType,t=r?n===a?parseFloat(r):r:void 0,f.push(t)),d.tokenType=null,d.text="",t},g=function(){f.length&&p.push(f),f=[]},S=function(e,n,c){return n?e.match(t.GROUPED_VALUE_STR_ENCLOSER_TAILING)?l:r:e>="0"&&e<="9"||"."===e?a:e.match(/\s/)?u:e.match(t.GROUPED_VALUE_STR_ENCLOSER_LEADING)?i:e.match(t.GROUPED_VALUE_STR_ENCLOSER_TAILING)?l:e.match(t.GROUPED_VALUE_GROUP_DELIMITER)?c?s:o:e.match(t.GROUPED_VALUE_ITEM_DELIMITER)?s:r},A=!1,m=0,T=c.length;m<T;++m){var I=c.charAt(m),D=S(I,d.tokenType===n);D===u&&d.tokenType===n&&(d.text+=I,D=d.tokenType),D<i?(A&&d.text&&(h(),g()),d.tokenType?d.tokenType=Math.max(d.tokenType,D):d.tokenType=D,d.text+=I):D<s?D===i?(A&&d.text?(h(),g()):h(),d.tokenType=n):d.tokenType=r:D===s?h(!0):D===o&&(h(!0),g()),A=D===u}return h(),g(),p},decodeAffnGroupTableLines:function(e,t){for(var a=[],n=0,i=e.length;n<i;++n){var l=e[n];a=a.concat(r.decodeAffnGroupLine(l))}return a},getDataTableFormatDetails:function(e){if(e.startsWith(t.DATA_FORMAT_GROUP_LEADING)||e.endsWith(t.DATA_FORMAT_GROUP_TAILING)){var a=e.substr(t.DATA_FORMAT_GROUP_LEADING.length,e.length-t.DATA_FORMAT_GROUP_LEADING.length-t.DATA_FORMAT_GROUP_TAILING.length);if(l=(a=a.replace(/\s/g,"")).match(/^([a-zA-Z])\+\+\(([a-zA-Z])\.\.([a-zA-Z])\)$/))return l[2]!==l[3]?Kekule.error(Kekule.$L("ErrorMsg.JCAMP_DATA_TABLE_VAR_LIST_FORMAT_ERROR",e)):{format:t.DATA_VARLIST_FORMAT_XYDATA,varInc:l[1],varLoop:l[2],vars:[l[1],l[2]]};if(l=a.match(/^([a-zA-Z]+)\s*\.\.\s*([a-zA-Z]+)$/)){if(l[1]!==l[2])return Kekule.error(Kekule.$L("ErrorMsg.JCAMP_DATA_TABLE_VAR_LIST_FORMAT_ERROR",e));for(var r=[],n=0,i=l[1].length;n<i;++n)l[1].charAt(n).match(/\s/)||r.push(l[1].charAt(n));return{format:t.DATA_VARLIST_FORMAT_XYPOINTS,vars:r}}var l;if(l=a.match(/^(([a-zA-Z]\,?)+)$/)){for(r=[],n=0,i=l[1].length;n<i;++n)","!==l[1].charAt(n)&&r.push(l[1].charAt(n));return{format:t.DATA_VARLIST_FORMAT_VAR_GROUPS,vars:r}}return Kekule.error(Kekule.$L("ErrorMsg.JCAMP_DATA_TABLE_VAR_LIST_FORMAT_UNSUPPORTED",e))}return Kekule.error(Kekule.$L("ErrorMsg.JCAMP_DATA_TABLE_VAR_LIST_FORMAT_ERROR",e))},getDataTableFormatAndPlotDetails:function(e){var a=e.indexOf(t.DATA_FORMAT_GROUP_LEADING),n=e.lastIndexOf(t.DATA_FORMAT_GROUP_TAILING);if(a>=0&&n>=0){var i=e.substring(a,n+1),l=r.getDataTableFormatDetails(i),s=e.substr(n+1).trim();return s.indexOf(t.DATA_FORMAT_PLOT_DESCRIPTOR_DELIMITER)>=0&&(s=s.substr(t.DATA_FORMAT_PLOT_DESCRIPTOR_DELIMITER.length),l.plotDescriptor=s),l}Kekule.error(Kekule.$L("ErrorMsg.JCAMP_DATA_TABLE_VAR_LIST_FORMAT_ERROR",e))},_createBlock:function(e){return{blocks:[],ldrs:[],ldrIndexes:{},_parent:e}},_getNestedBlockLevelCount:function(e){var t=1,a=e.blocks;if(a&&a.length){for(var r=0,n=0,i=a.length;n<i;++n){var l=this._getNestedBlockLevelCount(a[n]);l>r&&(r=l)}t+=r}return t},_getBlockLdr:function(e,t){var a=e.ldrIndexes[t];return a>=0?e.ldrs[a]:null},_getBlockMeta:function(a){var r=a.meta;return r||(r={blockType:a.blocks.length?e.BlockType.LINK:e.BlockType.DATA,format:a.ldrIndexes[t.LABEL_DX_VERSION]?e.Format.DX:a.ldrIndexes[t.LABEL_CS_VERSION]?e.Format.CS:null},a.meta=r),r}};var r=Kekule.IO.Jcamp.Utils;Kekule.IO.Jcamp.ValueType={AFFN:1,ASDF:2,AFFN_ASDF:3,MULTILINE_AFFN_ASDF:5,MULTILINE_AFFN_GROUP:6,SIMPLE_AFFN_GROUP:7,STRING_GROUP:8,DATA_TABLE:9,STRING:10,SHORT_DATE:21,SHORT_TIME:22,DATETIME:23,NONE:0};var n=Kekule.IO.Jcamp.ValueType;Kekule.IO.Jcamp.LabelType={GLOBAL:0,SPECIFIC:1,PRIVATE:2};var i=Kekule.IO.Jcamp.LabelType;Kekule.IO.Jcamp.LabelCategory={GLOBAL:"global",META:"meta",PARAMTER:"parameter",CONDITION:"condition",ANNOTATION:"annotation"};var l=Kekule.IO.Jcamp.LabelCategory;Kekule.IO.Jcamp.LabelTypeInfos={_DEFAULT_TYPE:n.STRING},Kekule.IO.Jcamp.LabelTypeInfos.createInfo=function(e,a,n,s,o){var u=r.standardizeLdrLabelName(e),c=o?i.SPECIFIC:i.GLOBAL;n||(n=c),s||(s=n===i.GLOBAL?l.META:l.ANNOTATION),n!==i.SPECIFIC||u.startsWith(t.SPECIFIC_LABEL_PREFIX)?n!==i.PRIVATE||u.start(t.PRIVATE_LABEL_PREFIX)||(u=t.PRIVATE_LABEL_PREFIX+u):u=t.SPECIFIC_LABEL_PREFIX+u;var d={labelName:u,labelType:n,labelCategory:s,dataType:a};return o&&(d.specificType=o),Kekule.IO.Jcamp.LabelTypeInfos[u]=d,d},Kekule.IO.Jcamp.LabelTypeInfos.createInfos=function(e){for(var t=0,a=e.length;t<a;++t){var r=e[t];Kekule.IO.Jcamp.LabelTypeInfos.createInfo.apply(null,r)}},Kekule.IO.Jcamp.LabelTypeInfos.getType=function(e){var t=s[e];return t&&t.dataType||s._DEFAULT_TYPE},Kekule.IO.Jcamp.LabelTypeInfos.getCategory=function(e){var t=s[e];return t&&t.labelCategory||l.ANNOTATION},Kekule.IO.Jcamp.LabelTypeInfos.getInfo=function(e,t){var a=s[e];return a&&t&&a.labelType!==t?null:a};var s=Kekule.IO.Jcamp.LabelTypeInfos;(0,Kekule.IO.Jcamp.LabelTypeInfos.createInfos)([["TITLE",n.STRING,null,l.GLOBAL],["JCAMPDX",n.STRING],["JCAMPCX",n.STRING],["DATA TYPE",n.STRING],["BLOCKS",n.AFFN],["END",n.NONE],["XUNITS",n.STRING],["YUNITS",n.STRING],["XLABEL",n.STRING],["YLABEL",n.STRING],["FIRSTX",n.AFFN],["LASTX",n.AFFN],["FIRSTY",n.AFFN],["MAXX",n.AFFN],["MINX",n.AFFN],["MAXY",n.AFFN],["MINY",n.AFFN],["DELTAX",n.AFFN],["XFACTOR",n.AFFN],["YFACTOR",n.AFFN],["NPOINTS",n.AFFN],["RESOLUTION",n.STRING,null,l.PARAMTER],["XYDATA",n.MULTILINE_AFFN_ASDF],["XYPOINTS",n.MULTILINE_AFFN_GROUP],["PEAK TABLE",n.MULTILINE_AFFN_GROUP],["PEAK ASSIGNMENTS",n.MULTILINE_AFFN_GROUP],["CLASS",n.STRING],["ORIGIN",n.STRING],["OWNER",n.STRING],["DATE",n.SHORT_DATE,null,l.GLOBAL],["TIME",n.SHORT_TIME,null,l.GLOBAL],["LONGDATE",n.DATETIME,null,l.GLOBAL],["SOURCE REFERENCE",n.STRING],["CROSS REFERENCE",n.STRING],["SAMPLE DESCRIPTION",n.STRING],["CAS NAME",n.STRING],["NAMES",n.STRING],["MOLFORM",n.STRING],["CAS REGISTRY NO",n.STRING],["WISWESSER",n.STRING],["BEILSTEIN LAWSON NO",n.STRING],["REFRACTIVE INDEX",n.AFFN],["DENSITY",n.AFFN],["MW",n.AFFN],["MP",n.AFFN],["BP",n.AFFN],["CONCENTRATIONS",n.STRING],["SPECTROMETER/DATA SYSTEM",n.STRING],["INSTRUMENTAL PARAMETERS",n.STRING],["SAMPLING PROCEDURE",n.STRING],["STATE",n.STRING],["PATH LENGTH",n.STRING],["PRESSURE",n.STRING],["TEMPERATURE",n.STRING],["DATA PROCESSING",n.STRING],["RUNITS",n.STRING],["AUNITS",n.STRING],["FIRSTR",n.AFFN],["LASTR",n.AFFN],["FIRSTA",n.AFFN],["MAXA",n.AFFN],["MINA",n.AFFN],["DELTAR",n.AFFN],["RFACTOR",n.AFFN],["AFACTOR",n.AFFN],["ALIAS",n.AFFN],["ZPD",n.AFFN],["RADATA",n.MULTILINE_AFFN_ASDF],["APPLICATION",n.STRING],["DATACLASS",n.STRING],["DICTIONARY",n.STRING],["BLOCKID",n.STRING],["INDEX",n.STRING],["SMILES",n.STRING],["NTUPLES",n.STRING],["VAR_NAME",n.STRING_GROUP],["SYMBOL",n.STRING_GROUP],["VAR_TYPE",n.STRING_GROUP],["VAR_FORM",n.STRING_GROUP],["VAR_DIM",n.SIMPLE_AFFN_GROUP],["UNITS",n.STRING_GROUP],["FIRST",n.SIMPLE_AFFN_GROUP],["LAST",n.SIMPLE_AFFN_GROUP],["MIN",n.SIMPLE_AFFN_GROUP],["MAX",n.SIMPLE_AFFN_GROUP],["FACTOR",n.SIMPLE_AFFN_GROUP],["END NTUPLES",n.STRING],["PAGE",n.STRING],["DATA TABLE",n.DATA_TABLE]]),Kekule.IO.Jcamp.LdrValueParser={_parserFuncs:{byLabelName:{},byDataType:{}},registerParser:function(e,t,a){e?o._parserFuncs.byLabelName[r.standardizeLdrLabelName(e)]=a:t&&(o._parserFuncs.byDataType[t]=a)},getParserFunc:function(t){var a=e.Utils.standardizeLdrLabelName(t.labelName),r=o._parserFuncs.byLabelName[a];if(!r){var n=s.getType(a);r=o._parserFuncs.byDataType[n]}return r||(r=o._parserFuncs._default),r},parseValue:function(e,t){return o.getParserFunc(e)(e.valueLines,t)},stringParser:function(e,t){return e.join("\n")},affnParser:function(e,t){var a=r.getFirstNonemptyLine(e),n=parseFloat(a);return Kekule.NumUtils.isNormalNumber(n)?n:NaN},asdfParser:function(e,t){var a=r.getFirstNonemptyLine(e),n=r.decodeAsdfLine(a);return n&&n[0]},shortDateParser:function(e,t){var a=r.getFirstNonemptyLine(e).split("/");return{year:parseInt(a[0])||0,month:parseInt(a[1])||0,day:parseInt(a[2])||0}},shortTimeParser:function(e,t){var a=r.getFirstNonemptyLine(e).split(":");return{hour:parseInt(a[0])||0,minute:parseInt(a[1])||0,second:parseInt(a[2])||0}},longDateParser:function(e,t){var a=0,n=0,i=0,l=null,s=null,o=null,u=null,c=r.getFirstNonemptyLine(e).split(/\s+/g),d=/(\d+)\/(\d+)\/(\d+)/,p=(c[0]||"").match(d);p&&(a=parseInt(p[1])||0,n=parseInt(p[2])||0,i=parseInt(p[3])||0);var f=(c[1]||"").trim();return f&&(d=/(\d+)\:(\d+)\:(\d+)(\.(\d+))?/,(p=f.match(d))&&(l=parseInt(p[1]),s=parseInt(p[2]),o=parseInt(p[3]),u=parseInt(p[5])||null)),new Date(a,n-1,i,l,s,o,u)},stringGroupParser:function(e,a){var r=e.join(" ").trim();r.endsWith(t.SIMPLE_VALUE_DELIMITER)&&(r=r.substr(0,r.length-t.SIMPLE_VALUE_DELIMITER.length));for(var n=r.split(t.SIMPLE_VALUE_DELIMITER),i=0,l=n.length;i<l;++i){n[i]=n[i].trim();var s=n[i];s.startsWith(t.VALUE_STR_EXPLICIT_QUOTE)&&s.endsWith(t.VALUE_STR_EXPLICIT_QUOTE)&&(n[i]=s.substr(t.VALUE_STR_EXPLICIT_QUOTE.length,s.length-2*t.VALUE_STR_EXPLICIT_QUOTE.length))}return n},simpleAffnGroupParser:function(e){for(var a=e.join(" ").split(t.SIMPLE_VALUE_DELIMITER),r=0,n=a.length;r<n;++r)a[r]=parseFloat(a[r].trim());return a},xyDataTableParser:function(t,a){var n={format:t[0],formatDetail:e.Utils.getDataTableFormatAndPlotDetails(t[0])},i=a&&a.doValueCheck&&!!n.formatDetail.varInc,l=Object.extend(a||{},{doValueCheck:i});return n.values=r.decodeAsdfTableLines(t.slice(1),l),n},groupedDataTableParser:function(t,a){return{format:t[0],formatDetail:e.Utils.getDataTableFormatAndPlotDetails(t[0]),values:r.decodeAffnGroupTableLines(t.slice(1),a)}},ntuplesDataTableParser:function(t,a){var r,n=e.Utils.getDataTableFormatAndPlotDetails(t[0]);return n.format===e.Consts.DATA_VARLIST_FORMAT_XYDATA?r=o.xyDataTableParser(t,a):n.format===e.Consts.DATA_VARLIST_FORMAT_XYPOINTS?r=o.groupedDataTableParser(t,a):n.format===e.Consts.DATA_VARLIST_FORMAT_VAR_GROUPS&&(r=o.groupedDataTableParser(t,a)),r}};var o=Kekule.IO.Jcamp.LdrValueParser;o._parserFuncs._default=o.stringParser,o.registerParser(null,n.AFFN,o.affnParser),o.registerParser(null,n.ASDF,o.asdfParser),o.registerParser(null,n.STRING,o.stringParser),o.registerParser(null,n.SHORT_DATE,o.shortDateParser),o.registerParser(null,n.SHORT_TIME,o.shortTimeParser),o.registerParser(null,n.DATETIME,o.longDateParser),o.registerParser(null,n.MULTILINE_AFFN_ASDF,o.xyDataTableParser),o.registerParser(null,n.MULTILINE_AFFN_GROUP,o.groupedDataTableParser),o.registerParser(null,n.DATA_TABLE,o.ntuplesDataTableParser),o.registerParser(null,n.STRING_GROUP,o.stringGroupParser),o.registerParser(null,n.SIMPLE_AFFN_GROUP,o.simpleAffnGroupParser),Kekule.IO.Jcamp.BlockReaderManager={_readerClasses:[],_findRegisteredItemIndex:function(e,t,a,r){for(var n=Kekule.ObjUtils.isUnset,i=u._readerClasses,l=i.length-1;l>=0;--l){var s=i[l];if((n(e)||e===s.blockType||r&&"*"===s.blockType)&&(n(t)||t===s.blockFormat||r&&"*"===s.blockFormat)&&(n(a)||a===s.readerClass))return l}return-1},register:function(e,t,a){u._findRegisteredItemIndex(e,t,a)<0&&u._readerClasses.push({blockType:e,blockFormat:t,readerClass:a})},unregister:function(e,t,a){var r=u._findRegisteredItemIndex(e,t,a);u._readerClasses.splice(r,1)},getReaderClass:function(e,t){var a=u._findRegisteredItemIndex(e,t,null,!0);return a>=0?u._readerClasses[a].readerClass:null}};var u=Kekule.IO.Jcamp.BlockReaderManager;Kekule.IO.Jcamp.BlockReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.Jcamp.BlockReader",initialize:function(e){this.setPropStoreFieldValue("ldrHandlerMap",{}),this.tryApplySuper("initialize",e),this._initLdrHandlers()},initProperties:function(){this.defineProp("ldrHandlerMap",{dataType:DataType.HASH,setter:!1,scope:Class.PropertyScope.PRIVATE})},_initLdrHandlers:function(){var e=this.getLdrHandlerMap();e._default=this._defaultLdrHandler.bind(this),e[t.LABEL_BLOCK_BEGIN]=this.doStoreLdrToChemObjInfoProp.bind(this,"title"),e[t.LABEL_DX_VERSION]=e[t.LABEL_DX_VERSION_2]=this.doStoreLdrToChemObjInfoProp.bind(this,"jcampDxVersion"),e[t.LABEL_BLOCK_END]=this._ignoreLdrHandler;var a=this.doStoreDateTimeLdr.bind(this);return e.DATE=a,e.TIME=a,e.LONGDATE=a,e},_defaultLdrHandler:function(e,t,a){return this.saveLdrValueToChemObjInfoProp(e.labelName,o.parseValue(e),a)},_ignoreLdrHandler:function(e,t,a){},_getBlockMeta:function(e){return r._getBlockMeta(e)},doCreateChemObjForBlock:function(e){return null},getLdrNamePrefixForInfoField:function(e,t,a){var r="jcamp.";return t===i.SPECIFIC||t===i.PRIVATE&&(r+="custom."),r},getLdrStorageParamsForInfoField:function(t,a){var r=e.Utils.analysisLdrLabelName(t),n=r.labelType,i=this.getLdrNamePrefixForInfoField(t,n,a);return{fullName:i?i+r.coreName:r.coreName,labelType:n,labelCategory:r.labelCategory}},saveLdrValueToChemObjInfoProp:function(e,t,a){var r,n=this.getLdrStorageParamsForInfoField(e,a),s=n.fullName,o=n.labelCategory;o===l.ANNOTATION?r=a.setAnnotation:o===l.PARAMTER?r=a.setParameter:o===l.CONDITION?r=a.setCondition:o===l.META?r=a.setMeta:o===l.GLOBAL?r=a.setInfoValue:n.labelType===i.PRIVATE&&(r=a.setAnnotation),r||(r=a.setInfoValue),r.apply(a,[s,t])},doStoreLdrToChemObjInfoProp:function(e,t,a,r){var n=o.parseValue(t);this.saveLdrValueToChemObjInfoProp(e,n,r)},doStoreDateTimeLdr:function(e,t,a){var n,i=e.labelName,l=o.parseValue(e);if("LONGDATE"===i)n=l;else if("DATE"===i){n=new Date(l.year,l.month-1,l.day);var s=r._getBlockLdr(t,"TIME");if(s){var u=o.parseValue(s);n.setHours(u.hour,u.minute,u.second)}}n&&this.saveLdrValueToChemObjInfoProp("date",n,a)},getPendingLdrNames:function(){return[]},getIgnoredLdrNames:function(){return[]},processLdr:function(e,t,a){return this.doProcessLdr(e,t,a)},doProcessLdr:function(e,t,a){var r=t.labelName,n=this.getLdrHandlerMap(),i=n[r]||n._default;i&&i(t,e,a)},doSetChemObjFromBlock:function(e,t){if(t){for(var a=this.getIgnoredLdrNames()||[],r=this.getPendingLdrNames()||[],n=[],i=0,l=e.ldrs.length;i<l;++i){var s=e.ldrs[i];a.indexOf(s.labelName)>=0||(r.indexOf(s.labelName)>=0?n.push(s):this.processLdr(e,s,t))}for(i=0,l=n.length;i<l;++i){s=n[i];this.processLdr(e,s,t)}}return t},doReadBlock:function(e,t){var a=this.doCreateChemObjForBlock(e);return a&&this.doSetChemObjFromBlock(e,a),a},doReadData:function(e,t,a,r){return this.doReadBlock(e,r)}}),Kekule.IO.Jcamp.DataBlockReader=Class.create(Kekule.IO.Jcamp.BlockReader,{CLASS_NAME:"Kekule.IO.Jcamp.DataBlockReader"}),Kekule.IO.Jcamp.LinkBlockReader=Class.create(Kekule.IO.Jcamp.BlockReader,{CLASS_NAME:"Kekule.IO.Jcamp.LinkBlockReader",doCreateChemObjForBlock:function(t){return this._getBlockMeta(t).blockType===e.BlockType.LINK?new Kekule.ChemObjList:this.tryApplySuper("doCreateChemObjForBlock",[t])},doReadBlock:function(e,t){var a;if(e.blocks.length<=0)return null;a=this.tryApplySuper("doReadBlock",[e]);for(var r=[],n=0,i=e.blocks.length;n<i;++n){var l=e.blocks[n],s=this._getBlockMeta(l),o=u.getReaderClass(s.blockType,s.format);if(o){var c=new o;try{var d=c.doReadData(l,t);d&&r.push(d)}finally{c.finalize()}}}if(r.length<=1)return a.finalize(),r[0];for(n=0,i=r.length;n<i;++n)a.appendChild(r[n]);return a}}),u.register(e.BlockType.LINK,"*",Kekule.IO.Jcamp.LinkBlockReader),u.register(e.BlockType.DATA,"*",Kekule.IO.Jcamp.DataBlockReader)}(),function(){"use strict";var e=Kekule.ArrayUtils,t=Kekule.IO.Jcamp,a=Kekule.Spectroscopy,r=Kekule.Unit;Kekule.IO.Jcamp.DxUtils={_dxUnitToMetricsObjMap:{"ARBITARY UNITS":r.Arbitrary.ARBITRARY,"ARBITARY UNIT":r.Arbitrary.ARBITRARY,SECONDS:r.Time.SECOND,SECOND:r.Time.SECOND,MILLISECONDS:r.Time.MILLISECOND,MICROSECONDS:r.Time.MICROSECOND,NANOSECONDS:r.Time.NANOSECOND,PPM:r.Dimensionless.PARTS_PER_MILLION,HZ:r.Frequency.HERTZ,"1/CM":r.WaveNumber.RECIPROCAL_CENTIMETER,MICROMETERS:r.Length.MICROMETER,NANOMETERS:r.Length.NANOMETER,TRANSMITTANCE:r.OpticalTransmittance.TRANSMITTANCE_PERCENT,REFLECTANCE:r.OpticalReflectance.REFLECTANCE,ABSORBANCE:r.OpticalAbsorbance.ABSORBANCE,"KUBELKA-MUNK":r.OpticalKubelkaMunk.KUBELKA_MUNK,"CHANNEL NUMBER":null,COUNTS:r.Misc.MS_COUNT,COUNT:r.Misc.MS_COUNT,"M/Z":r.SpectrumMS.MS_MASS_CHARGE_RATIO,"RELATIVE ABUNDANCE ":r.SpectrumMS.MS_RELATIVE_ABUNDANCE,MICROAMPERES:r.ElectricCurrent.MICROAMPERE,NANOAMPERES:r.ElectricCurrent.NANOAMPERE,PICOAMPERES:r.ElectricCurrent.PICOAMPERE},dxUnitToMetricsUnitSymbol:function(e){if(!e)return"";var a=t.DxUtils._dxUnitToMetricsObjMap[e],r=a&&a.symbol;return r||(r=e.toLowerCase().upperFirst()),r}},Kekule.IO.Jcamp.LabelTypeInfos.createInfos([["SPECTROMETER TYPE",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.MS],["INLET",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.MS],["IONIZATION MODE",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.MS],["OBSERVE FREQUENCY",t.ValueType.AFFN,null,t.LabelCategory.PARAMTER,a.SpectrumType.NMR],["OBSERVE NUCLEUS",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.NMR],["SOLVENT REFERENCE",t.ValueType.AFFN,null,t.LabelCategory.PARAMTER,a.SpectrumType.NMR],["DELAY",t.ValueType.SIMPLE_AFFN_GROUP,null,t.LabelCategory.PARAMTER,a.SpectrumType.NMR],["ACQUISITION MODE",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.NMR],["IMS PRESSURE",t.ValueType.AFFN,null,t.LabelCategory.PARAMTER,a.SpectrumType.IMS],["CARRIER GAS",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.IMS],["DRIFT GAS",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.IMS],["ELECTRIC FIELD",t.ValueType.SIMPLE_AFFN_GROUP,null,t.LabelCategory.PARAMTER,a.SpectrumType.IMS],["ION POLARITY",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.IMS],["IONIZATION MODE",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.IMS],["IMS TEMPERATURE",t.ValueType.SIMPLE_AFFN_GROUP,null,t.LabelCategory.PARAMTER,a.SpectrumType.IMS],["SHUTTER OPENING TIME",t.ValueType.AFFN,null,t.LabelCategory.PARAMTER,a.SpectrumType.IMS],["MASS ANALYSER",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.CHROMATOGRAPHY],["TANDEM SCANNING METHOD",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.CHROMATOGRAPHY],["INTERFACE",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.CHROMATOGRAPHY],["CHROMATOGRAPHY TYPE",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.CHROMATOGRAPHY],["CHROMATOGRAPHY SOLVENTS",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.CHROMATOGRAPHY],["ADDITIVES",t.ValueType.STRING,null,t.LabelCategory.PARAMTER,a.SpectrumType.CHROMATOGRAPHY],["DIMENSIONALITY",t.ValueType.AFFN,null,t.LabelCategory.PARAMTER,a.SpectrumType.CHROMATOGRAPHY]]),Kekule.IO.Jcamp.DxDataBlockReader=Class.create(Kekule.IO.Jcamp.DataBlockReader,{CLASS_NAME:"Kekule.IO.Jcamp.DxDataBlockReader",initProperties:function(){this.defineProp("currVarInfos",{dataType:DataType.HASH,setter:!1,scope:Class.PropertyScope.PRIVATE}),this.defineProp("currNTuplesInfos",{dataType:DataType.HASH,setter:!1,scope:Class.PropertyScope.PRIVATE}),this.defineProp("currNTuplesVarInfos",{dataType:DataType.HASH,setter:!1,scope:Class.PropertyScope.PRIVATE,getter:function(){var e=this.getCurrNTuplesInfos();return e&&e.varInfos}}),this.defineProp("currNTuplesVarRawInfos",{dataType:DataType.HASH,setter:!1,scope:Class.PropertyScope.PRIVATE,getter:function(){var e=this.getCurrNTuplesInfos();return e&&e.varRawInfos}})},initPropValues:function(){this._initCurrVarInfos()},_initCurrVarInfos:function(){this.setPropStoreFieldValue("currVarInfos",{}),this.setPropStoreFieldValue("currNTuplesVarInfos",{})},_initLdrHandlers:function(){var e=this.tryApplySuper("_initLdrHandlers");e[t.Consts.LABEL_BLOCK_BEGIN]=this.doStoreSpectrumTitleLdr.bind(this),e.DATATYPE=this.doStoreSpectrumDataTypeLdr.bind(this,"DATATYPE");for(var a=this.doStoreSpectrumDataLdr.bind(this),r=this._getDataTableLdrNames(),n=0,i=r.length;n<i;++n)e[r[n]]=a;var l=this._getDataTableVarDefLdrNames(),s=this.doStoreDataVarInfoLdr.bind(this);for(n=0,i=l.length;n<i;++n)e[l[n]]=s;var o=this._getNTuplesDefinitionLdrNames(),u=this.doStoreNTuplesAttributeLdr.bind(this);for(n=0,i=o.length;n<i;++n)e[o[n]]=u;e.DATATABLE=this.doStoreNTuplesDataLdr.bind(this);for(var c=this._getSpectrumParamLdrNames(),d=Kekule.ObjUtils.getOwnedFieldNames(c),p=(n=0,d.length);n<p;++n)for(var f=d[n],h=this.doStoreSpectrumParamLdr.bind(this,f),g=c[f],S=0,A=g.length;S<A;++S)e[g[S]]=h;return e},_getDataTableVarDefLdrNames:function(){return["XUNITS","FIRSTX","LASTX","MAXX","MINX","XFACTOR","YUNITS","MAXY","MINY","FIRSTY","LASTY","YFACTOR","NPOINTS","DELTAX","XLABEL","YLABEL","RUNITS","AUNITS","FIRSTR","LASTR","DELTAR","MAXA","MINA","RFACTOR","AFACTOR","FIRSTA","ALIAS","ZPD"]},_getNTuplesDefinitionLdrNames:function(){return["NTUPLES","VARNAME","SYMBOL","VARTYPE","VARFORM","VARDIM","UNITS","FIRST","LAST","MIN","MAX","FACTOR","PAGE","POINTS","CASNAME","ENDNTUPLES"]},_getDataTableLdrNames:function(){return["XYDATA","XYPOINTS","PEAKTABLE","PEAKASSIGNMENTS","ASSIGNMENTS","RADATA"]},_isDataTableLabelName:function(e){return this._getDataTableLdrNames().indexOf(e)>=0},_getSpectrumParamLdrNames:function(){return{ir:["RESOLUTION"],nmr:[".OBSERVEFREQUENCY",".OBSERVENUCLEUS",".SOLVENTREFERENCE",".DELAY",".ACQUISITIONMODE"],ms:[".SPECTROMETERTYPE",".INLET",".IONIZATIONMODE"],ims:[".IMSPRESSURE",".CARRIERGAS",".DRIFTGAS",".ELECTRICFIELD",".IONPOLARITY",".IONIZATIONMODE",".IMSTEMPERATURE",".SHUTTEROPENINGTIME"],chromatography:[".MASSANALYSER",".TANDEMSCANNINGMETHOD",".INTERFACE",".CHROMATOGRAPHYTYPE",".CHROMATOGRAPHYSOLVENTS",".ADDITIVES",".DIMENSIONALITY"]}},getLdrNamePrefixForInfoField:function(e,a,r){var n=this.tryApplySuper("getLdrNamePrefixForInfoField",[e,a,r]);if(a===t.LabelType.SPECIFIC){var i=r.getSpectrumType();i&&(n+=i+".")}return n},doStoreSpectrumTitleLdr:function(e,a,r){r.setTitle(t.LdrValueParser.parseValue(e))},doStoreDataVarInfoLdr:function(e,a,r){this.getCurrVarInfos()[e.labelName]=t.LdrValueParser.parseValue(e)},doStoreNTuplesAttributeLdr:function(e,a,r){var n=this.getCurrNTuplesInfos(),i=t.LdrValueParser.parseValue(e);"ENDNTUPLES"===e.labelName?(i!==n.name&&Kekule.error(Kekule.$L("ErrorMsg.JCAMP_NTUPLES_BEGIN_END_NAME_NOT_MATCH",n.value,i)),this.setPropStoreFieldValue("currNTuplesInfos",null)):"NTUPLES"===e.labelName?this.setPropStoreFieldValue("currNTuplesInfos",{name:i,varRawInfos:{}}):"PAGE"===e.labelName?this._doStoreNTuplesPageAttributeLdr(e):n.varRawInfos[e.labelName]=i},_doStoreNTuplesPageAttributeLdr:function(e){var t=this.getCurrNTuplesInfos(),a=e.valueLines.join(""),r=a.split("=");if(2!==r.length)Kekule.error(Kekule.$L("ErrorMsg.JCAMP_NTUPLES_PAGE_DECLARATION_FORMAT_ERROR",a));else{var n=r[0].trim(),i=r[1].trim();t[e.labelName]={varSymbol:n,sValue:i}}},doStoreSpectrumDataTypeLdr:function(e,a,r,n){var i=t.LdrValueParser.parseValue(a);if(i&&i.toUpperCase){var l=Kekule.Spectroscopy.SpectrumType,s=(i=i.toUpperCase()).indexOf("INFRARED")>=0?l.IR:i.indexOf("NMR")>=0?l.NMR:i.indexOf("MASS")>=0?l.MS:i.indexOf("ION MOBILITY")>=0||i.indexOf("IMS")>=0?l.IMS:i.indexOf("RAMAN")>=0?l.RAMAN:i.indexOf("UV")>=0?l.UV:l.GENERAL;n.setSpectrumType(s)}this.doStoreLdrToChemObjInfoProp(e,a,r,n)},doStoreSpectrumDataLdr:function(e,a,r){if(!this._isSpectrumDataLdr(e,r))return this.doStoreLdrToChemObjInfoProp(e.labelName,e,a,r);if(this._isDataTableLabelName(e.labelName)){var n=t.LdrValueParser.parseValue(e,{doValueCheck:!0}),i=n.formatDetail,l=i.vars,s=this._retrieveSpectrumDataVarInfos(l,a,r);s[0].dependency=Kekule.VarDependency.INDEPENDENT,s[1].dependency=Kekule.VarDependency.DEPENDENT;var o=this._createSpectrumVariableDefinitions(s),u=r.getData();u.setVariables(o);var c=e.labelName.indexOf("PEAK")<0&&e.labelName.indexOf("ASSIGNMENT")<0;u.setMode(c?Kekule.Spectroscopy.DataMode.CONTINUOUS:Kekule.Spectroscopy.DataMode.PEAK);this._createSpectrumDataSectionByFormat(i,n.values,s,u)}},_retrieveSpectrumDataVarInfos:function(e,t,a){var r=[];r._symbols=[],r._bySymbol={};for(var n=this.getCurrVarInfos(),i=function(e){return n[e]},l=0,s=e.length;l<s;++l){var o=e[l];r.push({symbol:o,units:i(o+"UNITS"),firstValue:i("FIRST"+o),lastValue:i("LAST"+o),maxValue:i("MAX"+o),minValue:i("MIN"+o),factor:i(o+"FACTOR")}),r._symbols.push(o),r._bySymbol[o]=r[r.length-1]}return r},_createSpectrumVariableDefinitions:function(e){for(var a=[],r=0,n=e.length;r<n;++r){var i=e[r],l=i.varType;if(l)if("DEPENDENT"===l)i.dependency=Kekule.VarDependency.DEPENDENT;else if("INDEPENDENT"===l)i.dependency=Kekule.VarDependency.INDEPENDENT;else if("PAGE"===l)continue;var s=new Kekule.Spectroscopy.SpectrumVarDefinition({name:(i.name||"").toLowerCase(),symbol:i.symbol,unit:t.DxUtils.dxUnitToMetricsUnitSymbol(i.units),dependency:Kekule.ObjUtils.notUnset(i.dependency)?i.dependency:Kekule.VarDependency.DEPENDENT});Kekule.ObjUtils.notUnset(i.minValue)&&Kekule.ObjUtils.notUnset(i.maxValue)&&s.setInfoValue("displayRange",{min:i.minValue,max:i.maxValue}),a.push(s)}return a},doStoreNTuplesDataLdr:function(e,a,r){var n=this.getCurrNTuplesInfos(),i=this.getCurrNTuplesVarInfos();if(i||(i=this._retrieveNTupleVariableInfos(),n.varInfos=i),!(l=n.spectrumData)){var l,s=this._createSpectrumVariableDefinitions(i);(l=r.getData()).setVariables(s),n.spectrumData=l}var o=t.LdrValueParser.parseValue(e,{doValueCheck:!0}),u=o.formatDetail,c=u.plotDescriptor||"",d=(u.vars,c.indexOf("PEAK")<0&&c.indexOf("ASSIGNMENT")<0?Kekule.Spectroscopy.DataMode.CONTINUOUS:Kekule.Spectroscopy.DataMode.PEAK),p=this._createSpectrumDataSectionByFormat(u,o.values,i,l);p.setMode(d);var f=n.PAGE;p.setName(f.varSymbol+": "+f.sValue)},_retrieveNTupleVariableInfos:function(){var a=[];a._bySymbol={},a._symbols=[];var r=this.getCurrNTuplesVarRawInfos(),n=function(n,i,l){for(var s=t.Utils.standardizeLdrLabelName(n),o=e.toArray(r[s]),u=0,c=o.length;u<c;++u)l[u]||(l[u]={}),l[u][i]=o[u],"SYMBOL"===n&&(a._symbols[u]=o[u]);return l};n("VAR_NAME","name",a),n("SYMBOL","symbol",a),n("VAR_TYPE","varType",a),n("VAR_FORM","varForm",a),n("VAR_DIM","varDim",a),n("UNITS","units",a),n("FIRST","firstValue",a),n("LAST","lastValue",a),n("MIN","minValue",a),n("MAX","maxValue",a),n("FACTOR","factor",a);for(var i=0,l=a.length;i<l;++i)a[i].symbol&&(a._bySymbol[a[i].symbol]=a[i]);return a},doStoreSpectrumParamLdr:function(e,r,n,i){var l=e.toUpperCase();if(!i.getSpectrumType()||i.getSpectrumType()===l){var s=r.labelName,o=t.LdrValueParser.parseValue(r),u=function(){var e=s;e.startsWith(t.Consts.SPECIFIC_LABEL_PREFIX)&&(e=e.substr(t.Consts.SPECIFIC_LABEL_PREFIX.length)),i.setParameter(e.toLowerCase(),o)};if(l===a.SpectrumType.IR)"RESOLUTION"===s&&(o.indexOf(t.Consts.SIMPLE_VALUE_DELIMITER)<0&&(o=parseFloat(o)||o),i.setParameter("resolution",o));else if(l===a.SpectrumType.NMR)if(".OBSERVENUCLEUS"===s){var c=o.indexOf("C")>=0&&o.indexOf("13")>=0?a.SpectrumNMR.TargetNucleus.C13:a.SpectrumNMR.TargetNucleus.H;i.setParameter("nucleus",c)}else".OBSERVEFREQUENCY"===s?Kekule.NumUtils.isNormalNumber(o)&&i.setParameter("observeFrequency",Kekule.Scalar.create(o,Kekule.Unit.Frequency.MEGAHERTZ.symbol)):".SOLVENTREFERENCE"===s?Kekule.NumUtils.isNormalNumber(o)&&i.setParameter("solventReference",Kekule.Scalar.create(o,Kekule.Unit.Dimensionless.PARTS_PER_MILLION.symbol)):".DELAY"===s?Kekule.NumUtils.isNormalNumber(o)&&i.setParameter("delays",Kekule.Scalar.create(o,Kekule.Unit.Time.MICROSECOND.symbol)):".ACQUISITIONMODE"===s?i.setParameter("acquisitionMode",o.toLowerCase()):u();else l===a.SpectrumType.MS?u():(a.SpectrumType.IMS,u())}},_calcActualVarValue:function(e,t){return e*(t.factor||1)},_createSpectrumDataSectionByFormat:function(e,a,r,n){var i;return e.format===t.Consts.DATA_VARLIST_FORMAT_XYDATA?i=this._createXyDataFormatSpectrumDataSection(e,a,r,n):e.format===t.Consts.DATA_VARLIST_FORMAT_XYPOINTS?i=this._createXyPointsFormatSpectrumDataSection(e,a,r,n):e.format===t.Consts.DATA_VARLIST_FORMAT_VAR_GROUPS&&(i=this._createVarGroupFormatSpectrumDataSection(e,a,r,n)),i},_createXyDataFormatSpectrumDataSection:function(e,a,r,n){var i=e.varInc,l=e.varLoop,s=n.createSection(e.vars,Kekule.Spectroscopy.DataMode.CONTINUOUS);s.beginUpdate();try{var o={firstValue:this._calcActualVarValue(a[0][0],r._bySymbol[i]),lastValue:null};if(a.length>1){var u=(a[a.length-1][0]-a[a.length-2][0])/(a[a.length-2].length-1);o.lastValue=this._calcActualVarValue(a[a.length-1][0]+u*(a[a.length-1].length-2),r._bySymbol[i])}else o.lastValue=r[i].lastValue;0===t.Utils.compareFloat(o.firstValue,r._bySymbol[i].firstValue)&&0===t.Utils.compareFloat(o.lastValue,r._bySymbol[i].lastValue)||Kekule.error(Kekule.$L("ErrorMsg.JCAMP_DATA_TABLE_VALUE_FIRST_LAST_NOT_MATCH")),s.setContinuousVarRange(i,o.firstValue,o.lastValue);for(var c=0,d=a.length;c<d;++c)for(var p=a[c],f=1,h=p.length;f<h;++f)s.appendData([void 0,this._calcActualVarValue(p[f],r._bySymbol[l])]);s.setDataSorted(!0)}finally{s.endUpdate()}return s},_createXyPointsFormatSpectrumDataSection:function(e,t,a,r){var n=r.createSection(e.vars);n.beginUpdate();try{for(var i=0,l=t.length;i<l;++i)n.appendData(t[i]);n.setDataSorted(!0)}finally{n.endUpdate()}return n},_createVarGroupFormatSpectrumDataSection:function(e,t,a,r){var n=r.createSection(e.vars);n.beginUpdate();try{for(var i=0,l=t.length;i<l;++i)n.appendData(t[i]);n.setDataSorted(!0)}finally{n.endUpdate()}return n},_isSpectrumDataLdr:function(e,t){var a=!t.getData()||t.getData().getSectionCount()<=0;if(a){var r=t.getInfoValue("DATA CLASS")||null;r&&(a=e.labelName.replace(/\s/g,"").indexOf(r.replace(/\s/g,""))>=0)}return a},doCreateChemObjForBlock:function(e){var a=this._getBlockMeta(e);return a.blockType===t.BlockType.DATA&&a.format===t.Format.DX?new Kekule.Spectroscopy.Spectrum:this.tryApplySuper("doCreateChemObjForBlock",[e])}}),t.BlockReaderManager.register(t.BlockType.DATA,t.Format.DX,Kekule.IO.Jcamp.DxDataBlockReader)}(),function(){"use strict";Kekule.ArrayUtils;var e=Kekule.IO.Jcamp,t=e.Consts;Kekule.IO.JcampReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.JcampReader",initialize:function(e){this.tryApplySuper("initialize",e)},_removeInlineComments:function(e){var a=e.indexOf(t.INLINE_COMMENT_FLAG);return a>=0?e.substring(0,a):e},_parseLdrLines:function(a){var r=a[0].indexOf(t.DATA_LABEL_TERMINATOR),n=a[0].substring(t.DATA_LABEL_FLAG.length,r).trim();if(n){for(var i=[this._removeInlineComments(a[0].substr(r+1)).trim()],l=1,s=a.length;l<s;++l)i.push(this._removeInlineComments(a[l].trim()));return{labelName:e.Utils.standardizeLdrLabelName(n),valueLines:i}}return null},doCreateAnalysisTree:function(a){var r=e.Utils._createBlock,n=r(),i=n,l=this,s=function(a){var n=l._parseLdrLines(a);if(n){if(e.Utils.ldrLabelNameEqual(n.labelName,t.LABEL_BLOCK_BEGIN)){var s=r(i);i.blocks.push(s),i=s}!function(e,t){var a=l._parseLdrLines(e);a&&(t.ldrs.push(a),t.ldrIndexes[a.labelName]=t.ldrs.length-1)}(a,i),e.Utils.ldrLabelNameEqual(n.labelName,t.LABEL_BLOCK_END)&&(i=i._parent)}},o=new Kekule.TextLinesBuffer(a);o.reset();for(var u=[];!o.eof();){var c=o.readLine().trim();c.startsWith(t.DATA_LABEL_FLAG)?(u.length&&s(u),u=[c]):u.push(c)}return u.length&&s(u),n},doCheckAnalysisTree:function(t){t.ldrs.length&&Kekule.error(Kekule.$L("ErrorMsg.JCAMP_OTHER_LABEL_BEFORE_TITLE_LINE")),t.blocks.length>1&&Kekule.error(Kekule.$L("ErrorMsg.JCAMP_MORE_THAN_ONE_ROOT_BLOCK"));var a=t.blocks[0];return a||Kekule.error(Kekule.$L("ErrorMsg.JCAMP_DATA_WITHOUT_TITLE_LINE")),e.Utils._getNestedBlockLevelCount(a)>2&&Kekule.error(Kekule.$L("ErrorMsg.JCAMP_MORE_THAN_TWO_NEST_LEVEL")),!0},buildAnalysisTree:function(e){var t=this.doCreateAnalysisTree(e);return this.doCheckAnalysisTree(t)?t:null},doReadData:function(t,a,r,n){var i,l=this.buildAnalysisTree(t).blocks[0],s=e.Utils._getBlockMeta(l),o=e.BlockReaderManager.getReaderClass(s.blockType,s.format);if(o){var u=new o;try{i=u.doReadData(l,null,null,n)}finally{u.finalize()}}return i}}),Kekule.IO.DataFormat.JCAMP_DX="jcamp-dx",Kekule.IO.MimeType.JCAMP_DX="chemical/x-jcamp-dx",Kekule.IO.DataFormatsManager.register(Kekule.IO.DataFormat.JCAMP_DX,Kekule.IO.MimeType.JCAMP_DX,["jcamp","dx","jdx","jcm"],Kekule.IO.ChemDataType.TEXT,"JCAMP-DX format"),Kekule.IO.ChemDataReaderManager.register(Kekule.IO.DataFormat.JCAMP_DX,Kekule.IO.JcampReader,[Kekule.IO.DataFormat.JCAMP_DX])}(),function(){"use strict";Kekule.globalOptions.add("IO.cml",{enableExtractSampleInsideSpectrum:!0,autoHideSampleInsideSpectrum:!0});var e=Kekule.ArrayUtils,t=Kekule.ObjUtils,a=Kekule.DomUtils,r=Kekule.Spectroscopy.PeakShape,n=Kekule.Spectroscopy.PeakMultiplicity;Kekule.IO.CmlUtils._cmlUnitConvMap.push(["moverz","m/z","m/z"]),Kekule.IO.CML.SPECTRUM_OBJREF_FIELDNAME="__$objRef$__",Kekule.IO.CML.SPECTRUM_DATA_OBJREF_FLAG_FIELDNAME="__$hasObjRef$__",Kekule.IO.CmlSpectUtils={_peakShapeMap:[["sharp",r.SHARP],["broad",r.BROAD]],_peakMultiplicityMap:[["singlet",n.SINGLET],["doublet",n.DOUBLET],["triplet",n.TRIPLET],["quartet",n.QUARTET],["quintet",n.QUINTET],["sextuplet",n.SEXTUPLET],["multiplet",n.MULTIPLET]],_spectrumParamterKeyMap:[["cml:field","observeFrequency"],["jcamp:NMR_OBSERVEFREQUENCY","observeFrequency"],["jcamp:NMR_OBSERVENUCLEUS","nucleus"],["nmr:OBSERVENUCLEUS","nucleus"],["jcamp:resolution","resolution"]],cmlSpectrumTypeToKekule:function(e){for(var t=Kekule.Spectroscopy.SpectrumType,a=[["nmr",t.NMR],["infrared",t.IR],["ir",t.IR],["mass",t.MS],["uv",t.UV_VIS],["vis",t.UV_VIS]],r=t.GENERAL,n=e.toLowerCase(),i=0,l=a.length;i<l;++i){var s=a[i];if(n.indexOf(s[0])>=0){r=s[1];break}}return r},cmlSpectrumInfoDataKeyToKekule:function(e){for(var t=i._spectrumParamterKeyMap,a=0,r=t.length;a<r;++a)if(e===t[a][0])return t[a][1];return e},cmlPeakShapeToKekule:function(e){for(var t=i._peakShapeMap,a=e.toLowerCase(),r=0,n=t.length;r<n;++r)if(a===t[r][0])return t[r][1];return e},cmlPeakMultiplicityToKekule:function(e){for(var t=i._peakMultiplicityMap,a=e.toLowerCase(),r=0,n=t.length;r<n;++r)if(a===t[r][0])return t[r][1];return e},getSpectrumVarDef:function(e,t,a,r,n){n||(n=Kekule.VarDependency.INDEPENDENT);for(var i=e.getVariables(),l=0,s=i.length;l<s;++l){var o=i[l];if(!(t&&t!==o.getSymbol()||a&&a!==o.getUnit()||r&&r!==o.getName()||n!==o.getDependency()))return o}return null}};var i=Kekule.IO.CmlSpectUtils;Kekule.IO.CmlSampleReader=Class.create(Kekule.IO.CmlBaseListReader,{CLASS_NAME:"Kekule.IO.CmlSampleReader"}),Kekule.IO.CmlSpectrumPeakListReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlSpectrumPeakListReader",initialize:function(){this.tryApplySuper("initialize"),this._peakDetailsWithAssignments=[]},doFinalize:function(){this._peakDetailsWithAssignments=null,this.tryApplySuper("doFinalize")},doReadElement:function(e,t,a,r){var n=t instanceof Kekule.Spectroscopy.Spectrum?t:null;if(n){var i=[],l=this.getDomHelper().getElementsByTagNameNS(this.getCoreNamespaceURI(),"peak",e),s=this.doGetChildElementReader("peak");if(s)try{for(var o=0,u=l.length;o<u;++o){var c=s.readElement(l[o],null,this);c&&i.push(c)}}finally{}if(i.length){var d,p=n.getData(),f=this._analysisPeakVarInfo(i,n);if(f){var h=this._addPeakVariablesToSpectrumData(f,p,n);h&&h.length&&(d=p.createSection(h,Kekule.Spectroscopy.DataMode.PEAK),this._setVarLocalInfos(f,d),this._addPeakDataToSpectrumData(i,h,d,p,n))}return d}return null}return null},doDoneReadingDocument:function(){for(var e=this._peakDetailsWithAssignments,t=0,a=e.length;t<a;++t){var r=e[t];if(r instanceof Kekule.Spectroscopy.SpectrumPeakDetails){var n=r.getOwner();if(n&&n.getObjById){for(var i=r.getInfoValue(Kekule.IO.CML.SPECTRUM_OBJREF_FIELDNAME),l=[],s=0,o=i.length;s<o;++s){var u=i[s],c=n.getObjById(u);c&&l.push(c)}l.length&&r.setAssignments(l),delete r.getInfo()[Kekule.IO.CML.SPECTRUM_OBJREF_FIELDNAME]}}}this._peakDetailsWithAssignments=[]},_analysisPeakVarInfo:function(e,t){for(var a={},r=0,n=0,i=e.length;n<i;++n){for(var l=e[n],s=l.value,o=0,u=(d=s&&Kekule.ObjUtils.getOwnedFieldNames(s,!1)||[]).length;o<u;++o)a[d[o]]||(a[d[o]]={},++r);var c=l.units;if(c){var d;for(o=0,u=(d=Kekule.ObjUtils.getOwnedFieldNames(c,!1)||[]).length;o<u;++o)if(a[d[n]]&&!a[d[n]].units){var p=Kekule.IO.CmlUtils.cmlUnitStrToMetricsUnitSymbol(c[d[n]]);a[d[n]].units=p,p||(a[d[n]].title=Kekule.IO.CmlUtils.getCmlNsValueLocalPart(c[d[n]]))}}}return r<=0?null:(1===r&&t&&t.getSpectrumType()===Kekule.Spectroscopy.SpectrumType.NMR&&(a.y={units:Kekule.Unit.Arbitrary.ARBITRARY.symbol,displayLabel:Kekule.Unit.Arbitrary.ARBITRARY.name,defaultValue:1}),a)},_addPeakVariablesToSpectrumData:function(e,t,a){if(!e)return null;var r=Kekule.ObjUtils.getOwnedFieldNames(e,!1),n=r.indexOf("x");n<0&&(n=r.indexOf("X")),n<0&&(n=0);var i=r.splice(n,1);r.unshift(i[0]);for(var l=[],s=0,o=r.length;s<o;++s){var u={symbol:r[s],dependency:0===s?Kekule.VarDependency.INDEPENDENT:Kekule.VarDependency.DEPENDENT};e[r[s]].title&&(u.displayLabel=e[r[s]].title),e[r[s]].units&&(u.unit=e[r[s]].units);var c=Kekule.IO.CmlSpectUtils.getSpectrumVarDef(a,u.symbol,u.unit,null,u.dependency);c&&!c.getDisplayLabel()&&u.displayLabel&&c.setDisplayLabel(u.displayLabel),c||(c=new Kekule.Spectroscopy.SpectrumVarDefinition(u),t.appendVariable(c)),l.push(u.symbol)}return l},_setVarLocalInfos:function(e,t){for(var a=Kekule.ObjUtils.getOwnedFieldNames(e,!1),r=0,n=a.length;r<n;++r){var i=e[a[r]];Kekule.ObjUtils.notUnset(i.defaultValue)&&t.setDefaultVarValue(a[r],i.defaultValue)}},_addPeakDataToSpectrumData:function(e,t,a,r,n){for(var i=0,l=e.length;i<l;++i){for(var s=e[i],o=[],u=0,c=t.length;u<c;++u){var d=t[u],p=s.value[d];o.push(p)}this._setPeakDetails(s,o,a),a.appendData(o)}},_setPeakDetails:function(e,t,a){if(e.subStructure||e.multiplicity||e.shape){var r=new Kekule.Spectroscopy.SpectrumPeakDetails({multiplicity:e.multiplicity,shape:e.shape});e.subStructure&&r.setInfoValue("structure",e.subStructure);var n=this._getPeakObjRefIds(e);return n&&(r.setInfoValue(Kekule.IO.CML.SPECTRUM_OBJREF_FIELDNAME,n),this._peakDetailsWithAssignments.push(r)),a.setExtraInfoOf(t,r),r}return null},_getPeakObjRefIds:function(e){for(var t=[],a=0,r=Kekule.IO.CML.ATOMS_REF_ATTRIBS.length;a<r;++a){e[n=Kekule.IO.CML.ATOMS_REF_ATTRIBS[a]]&&(t=t.concat(e[n].split(/\s/)))}for(a=0,r=Kekule.IO.CML.BONDS_REF_ATTRIBS.length;a<r;++a){var n;e[n=Kekule.IO.CML.BONDS_REF_ATTRIBS[a]]&&(t=t.concat(e[n].split(/\s/)))}var i=[];for(a=0,r=t.length;a<r;++a){var l=t[a].trim();l&&i.push(l)}return i.length?i:null}}),Kekule.IO.CmlSpectrumPeakReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlSpectrumPeakReader",doReadElement:function(e,t,r,n){var i={};return this.readPeakAttribs(i,e,this.getDomHelper()),this.iterateChildElements(e,i,this,function(e,t){"peakstructure"===a.getLocalName(e).toLowerCase()&&(i.subStructure||(i.subStructure=[]),i.subStructure.push(t))}),i},readPeakAttribs:function(e,t,a){for(var r=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(t,null,!0,a),n=Kekule.ObjUtils.getOwnedFieldNames(r),l=0,s=n.length;l<s;++l){var o=n[l],u=o.toLowerCase();"peakheight"===u&&(o="yValue",u="yvalue");var c=r[o];if(u.indexOf("units")>=0){var d=this._getVarSymbolInName(o,"units");e.units||(e.units={}),e.units[d]=Kekule.IO.CmlUtils.cmlUnitStrToMetricsUnitSymbol(c)}else if(u.indexOf("value")>=0){d=this._getVarSymbolInName(o,"value");e.value||(e.value={}),e.value[d]=Kekule.IO.CmlUtils.tryParseFloat(c)}else"peakmultiplicity"===u?e.multiplicity=i.cmlPeakMultiplicityToKekule(c):"peakshape"===u?e.shape=i.cmlPeakShapeToKekule(c):e[o]=c}},_getVarSymbolInName:function(e,t){var a=e.toLowerCase().indexOf(t.toLowerCase());return a>0?e.substring(0,a):null}}),Kekule.IO.CmlSpectrumPeakStructureReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlSpectrumPeakStructureReader",doReadElement:function(e,t,a,r){for(var n={},i=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(e,null,!0,this.getDomHelper()),l=Kekule.ObjUtils.getOwnedFieldNames(i),s=0,o=l.length;s<o;++s){var u=l[s],c=u.toLowerCase(),d=i[u];"units"===c?n.unit=Kekule.IO.CmlUtils.cmlUnitStrToMetricsUnitSymbol(d)||Kekule.IO.CmlUtils.getCmlNsValueLocalPart(d):n[u]=d}return n}}),Kekule.IO.CmlSpectrumDataAxisReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlSpectrumDataAxisReader",initProperties:function(){this.defineProp("axisSymbol",{dataType:DataType.STRING,serializable:!1}),this.defineProp("childArrayObj",{dataType:DataType.OBJECT,serializable:!1})},doReadElement:function(e,t,r,n){var i=a.getLocalName(e).toLowerCase(),l=i.indexOf("axis"),s=i.substring(0,l),o=a.getSameNSAttributeValue(e,"multiplierToData",this.getDomHelper());o&&(o=parseFloat(o)),this.setAxisSymbol(s),this.tryApplySuper("doReadElement",[e,t,r]),this.iterateChildElements(e,t,r);var u={symbol:this.getAxisSymbol(),array:this.getChildArrayObj()};return o&&(u.dataMultiplier=o),u},doReadChildElement:function(e,t,r){if("array"!==a.getLocalName(e).toLowerCase())return this.tryApplySuper("doReadChildElement",[e,t,r]);var n=this.doGetChildElementReader(e);if(n){n.setExpandSteppedArray&&n.setExpandSteppedArray(!1),n.setDefaultItemDataType&&n.setDefaultItemDataType("xsd:float");var i=n.readElement(e,t,r);i&&this.setChildArrayObj(i)}}}),Kekule.IO.CmlSpectrumDataReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlSpectrumDataReader",doReadElement:function(e,t,a,r){if(t instanceof Kekule.Spectroscopy.Spectrum){var n=new Kekule.Spectroscopy.SpectrumDataSection;t.appendDataSection(n);var i=this.iterateChildElements(e,t,a);return this._handleChildResults(i,n),n}},_handleChildResults:function(e,t){for(var r=[],n=0,i=e.length;n<i;++n){var l=e[n],s=l.element;a.getLocalName(s).toLowerCase().indexOf("axis")>=0&&("x"===l.result.symbol.toLowerCase()?r.unshift(l.result):r.push(l.result))}r.length>=2&&this._fillSpectrumData(r,t)},_fillSpectrumData(e,t){for(var a=t.getParentSpectrum(),r=a.getData(),n=0,i=[],l=0,s=e.length;l<s;++l){var o=0===l,u=this._getAxisVarDefParams(e[l],o);i.push(u);var c=e[l].array.size||e[l].array.values&&e[l].array.values.length;c>n&&(n=c)}var d=this._addSpectrumDataVarDefs(i,r,a);t.setLocalVarSymbols(d),this._setDataSectionLocalVarInfos(i,t);for(l=0;l<n;++l){for(var p=[],f=0,h=e.length;f<h;++f){var g=e[f].dataMultiplier||1,S=e[f].array.values;S?p.push(S[l]*g):p.push(void 0)}t.appendData(p)}},_getAxisVarDefParams:function(e,a){for(var r=e.symbol,n={symbol:r,dependency:a?Kekule.VarDependency.INDEPENDENT:Kekule.VarDependency.DEPENDENT},i={},l=e.array,s=t.getOwnedFieldNames(l),o=!1,u=0,c=s.length;u<c;++u){var d=s[u].toLowerCase(),p=l[s[u]];"unit"===d||"units"===d?(n.unit=Kekule.IO.CmlUtils.cmlUnitStrToMetricsUnitSymbol(p),n.unit||n.displayLabel||(n.displayLabel=Kekule.IO.CmlUtils.getCmlNsValueLocalPart(p))):"title"===d?n.displayLabel=p:"start"===d||"end"===d||"size"===d||"stepsize"===d||"value"===d||"values"===d||"datatype"===d||(i[s[u]]=p,o=!0)}var f;return!l.values&&l.start&&l.end&&(f={start:l.start,end:l.end}),{symbol:r,initParams:n,continuousInfo:f,hasExtraInfo:o,extraInfo:i}},_addSpectrumDataVarDefs:function(e,t,a){for(var r=[],n=0,i=e.length;n<i;++n){var l=e[n].initParams,s=Kekule.IO.CmlSpectUtils.getSpectrumVarDef(a,l.symbol,l.unit,null,l.dependency);s&&!s.getDisplayLabel()&&l.displayLabel&&s.setDisplayLabel(l.displayLabel),s||(s=new Kekule.Spectroscopy.SpectrumVarDefinition(l),t.appendVariable(s)),r.push(s.getSymbol())}return r},_setDataSectionLocalVarInfos:function(e,t){for(var a=0,r=e.length;a<r;++a){var n=e[a],i=n.symbol,l=n.continuousInfo;if(l&&t.setContinuousVarRange(i,l.start,l.end),n.hasExtraInfo){var s=n.extraInfo,o=Kekule.ObjUtils.getOwnedFieldNames(s);for(a=0,r=o.length;a<r;++a)t.setLocalVarInfoValue(i,o[a],s[o[a]])}}}}),Kekule.IO.CmlSpectrumReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlSpectrumReader",initialize:function(){this.tryApplySuper("initialize"),this._spectrumWithRefMolecules=[]},initProperties:function(){this.defineProp("convention",{dataType:DataType.STRING,serializable:!1}),this.defineProp("additionalRefMolecules",{dataType:DataType.ARRAY,serializable:!1})},doFinalize:function(){this._spectrumWithRefMolecules=null,this.setPropStoreFieldValue("additionalRefMolecules",null),this.tryApplySuper("doFinalize")},readElement:function(t,a,r,n){this.setAdditionalRefMolecules([]);var i=this.tryApplySuper("readElement",[t,a,r,n]),l=this.getAdditionalRefMolecules();if(l.length){var s=e.clone(l);s.push(i);var o=this._createChildObjsHolder(s,n.defaultRootObjListHolder);return i.setRefMolecules(l),o}return i},doReadElement:function(e,t,a,r){return this.readSpectrum(e,this.getDomHelper(),r)},doReadChildElement:function(e,t,r){var n=a.getLocalName(e).toLowerCase();return this._isInfoListElemTagName(n)?this.tryApplySuper("doReadChildElement",[e,null,r]):this.tryApplySuper("doReadChildElement",[e,t,r])},doDoneReadingDocument:function(){for(var e=this._spectrumWithRefMolecules,t=0,a=e.length;t<a;++t){var r=e[t],n=r.getOwner();if(n&&n.getObjById){for(var i=r[Kekule.IO.CML.SPECTRUM_OBJREF_FIELDNAME]||[],l=[],s=0,o=i.length;s<o;++s){var u=i[s].trim();if(u){var c=n.getObjById(u);c&&l.push(c)}}l.length&&r.setRefMolecules(l),delete r[Kekule.IO.CML.SPECTRUM_OBJREF_FIELDNAME]}}this._spectrumWithRefMolecules=[]},_isInfoListElemTagName:function(e){return["metadatalist","parameterlist","conditionlist","substancelist"].indexOf(e)>=0},readSpectrum:function(e,t,a){var r=new Kekule.Spectroscopy.Spectrum;this.readSpectrumAttribs(r,e,t);var n=this;this.iterateChildElements(e,r,this,function(e,t){n._handleChildResult(e,t,r,a)});return r},readSpectrumAttribs:function(e,t,a){for(var r=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(t,null,!0,a),n=Kekule.ObjUtils.getOwnedFieldNames(r),i=[],l=0,s=n.length;l<s;++l){var o=n[l],u=r[o];switch(Kekule.IO.CML.MOL_REF_ATTRIBS.indexOf(o)>=0&&i.push((u||"").trim()),o){case"id":e.setId(u);break;case"title":e.setTitle(u);break;case"type":var c=Kekule.IO.CmlSpectUtils.cmlSpectrumTypeToKekule(u);e.setSpectrumType(c);break;case"convention":this.setConvention(u);break;default:e.setInfoValue(o,u)}}if(i.length){var d=i.join(" ").split(/\s/);e[Kekule.IO.CML.SPECTRUM_OBJREF_FIELDNAME]=d,this._spectrumWithRefMolecules.push(e)}},_handleChildResult:function(e,t,r,n){var i=a.getLocalName(e).toLowerCase();"spectrumdata"===i||"peaklist"===i||("sample"===i&&n.enableExtractSampleInsideSpectrum?this._handleSampleData(t,r,n):this._isInfoListElemTagName(i)&&this._handleInfoData(i,t,r))},_handleSampleData:function(e,t,a){for(var r=[],n=0,i=e.length;n<i;++n){var l=e[n];l instanceof Kekule.Molecule&&(r.push(l),a.autoHideSampleInsideSpectrum&&l.setVisible&&l.setVisible(!1))}r.length&&this.setAdditionalRefMolecules(this.getAdditionalRefMolecules().concat(r))},_handleInfoData:function(e,t,a){for(var r=function(e,t){var a=null;return"metadatalist"===e?a=t.setMeta:"parameterlist"===e?a=t.setParameter:"conditionlist"===e?a=t.setCondition:"substancelist"===e||(a=t.setAnnotation),a}(e,a),n=0,i=t.length;n<i;++n){var l,s,o=r,u=t[n];if(u.key?(l=u.key,s=u.value):u instanceof Kekule.Scalar&&(l=u.getName(),s=u),l){var c=this._convertCmlSpectrumInfoKey(l);this._processCmlSpectrumInfoItem(l,c,s,a,e)||o.apply(a,[c,s])}}},_convertCmlSpectrumInfoKey:function(e){var t=i.cmlSpectrumInfoDataKeyToKekule(e),a=t.indexOf(":");return a>=0&&(t=t.substring(0,a)+"."+t.substring(a+1)),t},_processCmlSpectrumInfoItem:function(e,t,a,r,n){if("observeFrequency"===t){if(a instanceof Kekule.Scalar){var i=a.getValue(),l=a.getUnit();if(l&&l===Kekule.Unit.Frequency.HERTZ.symbol)return Kekule.UnitUtils.convertValue(i,l,Kekule.Unit.Frequency.MEGAHERTZ)<1&&a.setUnit(Kekule.Unit.Frequency.MEGAHERTZ.symbol),r.setParameter(t,a),!0}}else if("nucleus"===t&&"string"==typeof a){var s=a.indexOf("C")>=0&&a.indexOf("13")>=0?Kekule.Spectroscopy.SpectrumNMR.TargetNucleus.C13:Kekule.Spectroscopy.SpectrumNMR.TargetNucleus.H;return r.setParameter("nucleus",s),!0}return!1}});var l=Kekule.IO.CmlElementReaderFactory;l.register("spectrum",Kekule.IO.CmlSpectrumReader),l.register("peakList",Kekule.IO.CmlSpectrumPeakListReader),l.register("peak",Kekule.IO.CmlSpectrumPeakReader),l.register("peakStructure",Kekule.IO.CmlSpectrumPeakStructureReader),l.register("spectrumData",Kekule.IO.CmlSpectrumDataReader),l.register(["parameterList","substanceList"],Kekule.IO.CmlBaseListReader),l.register("sample",Kekule.IO.CmlSampleReader),l.register(["xaxis","yaxis"],Kekule.IO.CmlSpectrumDataAxisReader)}();